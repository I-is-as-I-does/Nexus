/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */
"use strict";(self.webpackChunknexus=self.webpackChunknexus||[]).push([[22],{453:(t,n,e)=>{e.d(n,{N:()=>rt});var a=e(696),d=e(425),i=e(931),r=e(947),c=e(371),l=e(75),s=e(85),o=e(451),u=e(null);function p(){var t=(0,r.O1)(10);return{nexus:a.Gd,author:{handle:"Anonymous-"+(0,r.Iy)(100,999),about:"",url:"http://"},threads:[h(t)],index:[t]}}function h(t){return{id:t,title:t,description:"...",content:{timestamp:(new Date).toISOString().substring(0,16),main:"...",aside:"",media:{url:"",type:"",caption:""}},linked:[]}}var f=e(549),v=e(142);function x(){var t=(0,d.gd)("BUTTON","nx-add-link");return t.type="button",t.textContent="+",t}const g=["youtube","vimeo","soundcloud"],D={image:["jpg","jpeg","gif","svg","png","webp"],video:["mp4","webm"],audio:["mp3"]};var m=e(220);const b=(0,c.hb)();var k,I,E,y,O,N,T,C={dataUrl:"nexus-tmp",srcData:null,threadId:"/",threadIndex:-1},L=null,S=new CustomEvent("IndexChange"),U=!1,V={ctrls:{prev:{symbol:"↶",elm:null},next:{symbol:"↷",elm:null}},position:0,count:1},w=[],j=null,A=null,B=null,P={up:"↑",down:"↓"},F={handle:null,url:null,about:null},J=null;function M(t,n){C.srcData.index.splice(n,0,C.srcData.index.splice(t,1)[0]),C.srcData.threads.splice(n,0,C.srcData.threads.splice(t,1)[0])}function Q(t,n){var e=C.srcData.index.indexOf(t);n.up.disabled=0==e,e+1==C.srcData.index.length?n.down.disabled=!0:n.down.disabled=!1}function R(t,n){j.removeChild(t),j.insertBefore(t,n),n.dispatchEvent(S),t.dispatchEvent(S)}function W(t,n,e){var c=(0,d.gd)("DIV","nx-edit-distant-link"),l={url:null,id:null,list:(0,d.gd)("DIV","nx-distant-ids")},s={id:null,url:null};l.id=_(["threads",n,"linked",e,"id"],null,s),l.url=_(["threads",n,"linked",e,"url"],(function(t,n){!function(t,n,e,i){var c=function(e=[]){var a=t.id.value;a&&e.includes(a)||(t.id.value="/"),e.unshift("/"),t.id.pattern="("+e.join("|")+")";var i=(0,d.Sb)(e,t.id,null,"nx-edit-linked-id");n.id.lastChild.replaceWith(i)};e&&i?(0,f.P)(e).then((t=>{c(Array.from(t.index))})).catch((()=>{t.url.pattern=a.Ni+"(?<!"+(0,r.hr)(e)+")",t.url.dispatchEvent(new window.Event("change"))})):c()}(s,l,t,n)}),s),Object.values(l).forEach((t=>{t&&(0,i.am)(c,t,!1,!0,200)}));var o,u=((o=(0,d.gd)("BUTTON","nx-delete-link")).type="button",o.textContent="-",o),p=(0,d.gd)("DIV","nx-distant-link-action");p.append(u),c.append(p),u.addEventListener("click",(()=>{var a=function(a){if(a)(0,i.Vv)(c,200,(function(){c.remove()}));else if(e==C.srcData.threads[n].linked.length-1)(0,i.am)(t,c,!1,!0,200);else{var d=t.childNodes[e];t.insertBefore(c,d),(0,i.YQ)(c,200)}};q(a),a(!0)})),t.append(c)}function Y(t,n){var e=(0,d.gd)("LI");return e.append(n),C.threadId!=t&&(e.style.display="none"),(0,c.Ek)((function(n){n.dataUrl==C.dataUrl&&(C=n,n.threadId==t?setTimeout((function(){(0,i.YQ)(e,200)}),200):(0,i.Vv)(e,200))})),e}function G(t,n){var e=Object.assign({},C);return e.threadId=n,e.threadIndex=t,e}function H(t,n,e=!1){var a=$(t,n);for(let[t,d]of Object.entries(a))!e||"index"!=t&&n!=C.threadId?d.parent.append(d.child):(0,i.am)(d.parent,d.child,!1,!0,200)}function $(t,n){var e={index:{parent:j,child:null,link:null,del:null},local:{parent:A,child:null},distant:{parent:B,child:null}};return e.index.child=(0,d.gd)("LI"),e.index.link=function(t,n){var e=G(t,n),a=(0,d.j1)(e,!1);return(0,d.I$)(a,e),a.addEventListener("click",(()=>{var t=C.srcData.index.indexOf(n);(0,c.f2)(G(t,n),!0)})),a}(t,n),e.index.child.append(e.index.link),function(t,n){var e=(0,d.gd)("DIV","nx-edit-move"),a={up:null,down:null};t.addEventListener("IndexChange",(function(){Q(n,a)})),Object.keys(a).forEach((i=>{a[i]=(0,d.gd)("BUTTON","nx-edit-move-"+i),a[i].type="button",a[i].textContent=P[i],e.append(a[i]),a[i].addEventListener("click",(function(){!function(t,n,e){var a=function(a){var d=C.srcData.index.indexOf(e),i="up"==n;a||(i=!i),i&&0!=d?(M(d,d-1),R(t,t.previousSibling)):i||d+1==C.srcData.index.length||(M(d,d+1),R(t.nextSibling,t))};q(a),a(!0)}(t,i,n)}))})),Q(n,a),t.append(e)}(e.index.child,n),e.distant.child=Y(n,function(t,n){var e=(0,d.gd)("FORM","nx-thread-distant-form"),a=C.srcData.threads[t].linked;if(a.length)for(var i=0;i<a.length;i++)W(e,t,i);var r=(0,d.gd)("DIV"),c=x();return c.addEventListener("click",(()=>{var t=C.srcData.index.indexOf(n),a=C.srcData.threads[t].linked.length;C.srcData.threads[t].linked.push({url:"",id:"/"}),W(e,t,a)})),r.append((0,d.a)("linked threads"),e,c),r}(t,n)),e.local.child=Y(n,function(t,n){var e=(0,d.gd)("FORM","nx-thread-local-form"),a=(0,d.gd)("FIELDSET");a.append(_(["threads",t,"title"],n)),a.append(_(["threads",t,"description"]));var i=(0,d.gd)("FIELDSET");["timestamp","main","aside"].forEach((n=>{i.append(_(["threads",t,"content",n]))}));var r=(0,d.gd)("FIELDSET"),c=_(["threads",t,"content","media","type"]);return r.append(_(["threads",t,"content","media","url"],(function(t,n){if(n){var e=c.querySelector("[data-item="+function(t){for(var n=0;n<g.length;n++)if(t.includes(g[n]))return g[n];var e=t.split(".").pop();for(let[t,n]of Object.entries(D))if(n.includes(e))return t;return"page"}(t)+"]");e&&e.click()}}))),r.append(c),r.append(_(["threads",t,"content","media","caption"])),e.append((0,d.a)("local thread"),a,(0,d.a)("content"),i,(0,d.a)("media",2),r),e}(t,(function(n,a){if(a){var d=(i=n,(0,r.V7)(i.trim().replace(/[\s_]/,"-")));e.index.link.firstChild.textContent=d,X(["threads",t,"id"],d)}var i}))),e.index.del=function(t,n,e){var a=(0,d.gd)("BUTTON","nx-delete-thread");return a.type="button",a.textContent="-",a.addEventListener("click",(function(){!function(t,n,e){var a=C.srcData.index.indexOf(e),d=j.childNodes[a],r=C.srcData.index.length,c={index:e,threads:C.srcData.threads[a]},l=function(e){if(e)Object.keys(c).forEach((t=>{C.srcData[t].splice(a,1)})),C.threadId="/",C.threadIndex=-1,[n,t,d].forEach((t=>{(0,i.Vv)(t,200,(function(){t.remove()}))})),r>1&&(0===a?d.nextSibling.dispatchEvent(S):a===r-1&&d.previousSibling.dispatchEvent(S));else{if(Object.keys(c).forEach((t=>{C.srcData[t].splice(a,0,c[t])})),a<r-1){var l=j.childNodes[a];j.insertBefore(d,l),0===a&&l.dispatchEvent(S)}else j.append(d),r>1&&d.previousSibling.dispatchEvent(S);(0,i.YQ)(d,200),A.append(t),B.append(n),d.firstChild.click()}};q(l),l(!0)}(t,n,e)})),a}(e.local.child,e.distant.child,n),e.index.child.append(e.index.del),e}function q(t){V.position!=V.count-1&&(w.splice(V.position),V.count=w.length+1),10===V.count?w.splice(0,1):V.count++,w.push(t),V.position=V.count-1,(0,d.eV)(V),I.disabled=!1}function X(t,n){return null===C.srcData&&(C.srcData={}),"author"==t[0]?function(t,n){C.srcData.author||(C.srcData.author={}),C.srcData.author[t[1]]=n}(t,n):(function(t){C.srcData.threads?void 0===C.srcData.threads[t[1]]&&(C.srcData.threads[t[1]]={}):C.srcData.threads=[]}(t),["linked","content"].includes(t[2])?("content"==t[2]&&function(t,n){C.srcData.threads[t[1]].content||(C.srcData.threads[t[1]].content={}),"media"==t[3]?(C.srcData.threads[t[1]].content.media||(C.srcData.threads[t[1]].content.media={}),C.srcData.threads[t[1]].content.media[t[4]]=n):C.srcData.threads[t[1]].content[t[3]]=n}(t,n),void function(t,n){C.srcData.threads[t[1]].linked?void 0===C.srcData.threads[t[1]].linked[t[3]]&&(C.srcData.threads[t[1]].linked[t[3]]={}):C.srcData.threads[t[1]].linked=[],C.srcData.threads[t[1]].linked[t[3]][t[4]]=n}(t,n)):function(t,n){C.srcData.threads[t[1]][t[2]]=n}(t,n))}function _(t,n=null,e=null){var i,r=function(t){return C.srcData?"author"==t[0]?C.srcData[t[0]][t[1]]:["linked","content"].includes(t[2])?"content"==t[2]?"media"!=t[3]?C.srcData.threads[t[1]].content[t[3]]:C.srcData.threads[t[1]].content.media[t[4]]:C.srcData.threads[t[1]].linked[t[3]][t[4]]:C.srcData.threads[t[1]][t[2]]:""}(t),c=t[t.length-1],s=t[t.length-2];Number.isInteger(s)&&(s=t[t.length-3]),i=["about","description","main","aside","caption"].includes(c)?function(t){var n=(0,d.gd)("TEXTAREA","nx-edit-textarea");return n.textContent=t,n}(r):"timestamp"==c?function(t){var n=(0,d.gd)("INPUT");return n.type="datetime-local",n.value=t,n}(r):function(t){var n=(0,d.gd)("INPUT","nx-edit-text");return n.type="text",n.value=t,n}(r);var o=t.join("-");i.id=o,i.name=o,["handle","title","main","id","url","type","timestamp"].includes(c)&&(i.required=!0);var u=function(t){var n=(0,d.gd)("LABEL","nx-edit-label");n.for=t;var e=(0,d.gd)("SPAN","nx-edit-title");return e.textContent=(0,l.GY)(t),(0,v.w)(e,t),n.append(e),n}(c),p=(0,d.gd)("SPAN","nx-edit-indication"),h=(0,d.gd)("SPAN","nx-edit-feedback");switch(u.append(p,h),c){case"url":p.textContent="[http]",i.pattern=a.Ni;break;case"id":t.includes("linked")?i.pattern=a.bt:i.pattern=a.Q1;break;case"type":i.pattern="("+a.WS.join("|")+")";break;case"timestamp":break;default:var f=a.m2[c];p.textContent="["+f[0]+"-"+f[1]+"]",i.setAttribute("maxlength",f[1]),i.setAttribute("minlength",f[0])}e&&(e[c]=i);var x=(0,d.gd)("DIV","nx-edit-input nx-edit-"+s+"-"+c);if(x.append(u),"type"==c||"id"==c&&"linked"==t[2]){var g=[];"type"==c?g=a.WS:(g=["/"],"/"!=r&&g.push(r)),x.append((0,d.Sb)(g,i,null,"nx-edit-"+t[2]+"-"+c))}else x.append(i);return function(t,n,e,a){var d="",i=n.value;n.addEventListener("focus",(function(){i=n.value})),n.addEventListener("change",(function(){z(t,n,e,a),q((function(r){r?n.value=d:(d=n.value,n.value=i),z(t,n,e,a)}))}))}(t,i,h,n),z(t,i,h,n),x}function z(t,n,e,a){var d=!1;n.checkValidity()?(d=!0,X(t,n.value),e.textContent="✓"):e.textContent="✗","function"==typeof a&&a(n.value,d)}function K(t){if(!U){var n=V.position,e=!1;"next"==t&&(n-=1,e=!0),w[n](e),setTimeout(function(){U=!1}.bind(this),b),I.disabled=!1}}function Z(){var t=!0;L!=JSON.stringify(C.srcData)&&(t=!1),E.disabled!==t&&(E.disabled=t)}function tt(t){var n=Object.assign({},C.srcData);null===t&&(t=p());var e=function(e){C.srcData.threads.length&&[j,A,B].forEach((t=>{Array.from(t.childNodes).forEach((t=>{(0,i.Vv)(t,200,(function(){t.remove()}))}))})),C.srcData=e?t:n,C.threadIndex=0,C.threadId=C.srcData.threads[0].id,function(){for(let[t,n]of Object.entries(F))n.value=C.srcData.author[t]}(),at(!0)};q(e),e(!0)}function nt(t){var n=(0,l.GY)(t);J&&clearTimeout(J),(0,i.Po)(y,n,20),J=setTimeout((function(){(0,i.Po)(y,"",20)}),2e3+20*n.length)}function et(){var t=(0,d.gd)("DIV","nx-edit-nav");y=(0,d.gd)("SPAN","nx-action-feedback"),(E=(0,d.gd)("BUTTON","nx-reset")).type="button",E.textContent="⭯",Z(),E.addEventListener("click",(function(){E.disabled||(tt(JSON.parse(L)),E.disabled=!0)})),(I=(0,d.gd)("BUTTON","nx-save")).type="button",I.textContent="🖫",I.disabled=!0,I.addEventListener("click",(function(){I.disabled||((0,s.EW)(C.dataUrl,C.srcData),nt("saved"),I.disabled=!0,Z())}));var n,e,a=(0,d.gd)("DIV");return a.append(E,((e=(0,d.gd)("BUTTON","nx-new")).type="button",e.textContent="🗋",e.addEventListener("click",(function(){tt(p())})),e),function(){var t=function(){var t=(0,d.gd)("INPUT");return t.type="file",t.accept="application/json",t.addEventListener("change",(function(t){(0,f.e)(t).then((t=>{tt(t)})).catch((()=>{nt("Invalid source")}))})),t.style.display="none",t}(),n=(0,d.gd)("BUTTON","nx-open-file");n.type="button",n.textContent="🗁",n.addEventListener("click",(function(){t.click()}));var e=(0,d.gd)("SPAN");return e.append(t,n),e}(),I,((n=(0,d.gd)("BUTTON","nx-download")).type="button",n.textContent="⇣",n.addEventListener("click",(function(t){var n=Object.assign({},C.srcData);delete n.index,(0,o.wJ)(n)||nt("Invalid Nexus data"),n=JSON.stringify(n,void 0,2);var e="data:text/json;charset=utf-8,"+encodeURIComponent(n),a=(0,d.gd)("A");a.setAttribute("href",e),a.setAttribute("download","nexus.json"),(0,u.X)().appendChild(a),a.click(),a.remove()})),n)),t.append(y,a),t}function at(t=!1){var n=C.srcData.index;if(n.length)for(var e=0;e<n.length;e++)H(e,n[e],t)}function dt(){var t=(0,d.gd)("DIV","nx-edit-list");return t.append((0,d.a)("threads"),j),t}function it(){return k=(0,d.gd)("FORM","nx-edit-author"),["handle","url","about"].forEach((t=>{k.append(_(["author",t],null,F))})),(0,d.rH)("index",null,[(n=(0,d.gd)("DIV","nx-edit-author-form"),n.append((0,d.a)("author"),k),n),dt(),(t=x(),t.addEventListener("click",(function(){var t=(0,r.O1)(10),n=C.srcData.index.length;C.srcData.threads.push(h(t)),C.srcData.index.push(t);var e=$(n,t);["local","distant"].forEach((t=>{e[t].parent.append(e[t].child)}));var a=null;j.childNodes.length&&(a=function(){j.childNodes[n-1].dispatchEvent(S)}),(0,i.am)(e.index.parent,e.index.child,!1,!0,200,a),I.disabled=!1})),t)],!1);var t,n}function rt(t){!function(t){var n="nexus-tmp";t.dataUrl&&(n=t.dataUrl);var e=(0,s.Ih)(n);null===e&&(e=null!==t.srcData?t.srcData:p(),(0,s.EW)(n,e)),L=null!==t.srcData?JSON.stringify(t.srcData):JSON.stringify(e);var a=e.threads[0].id,d=0;t&&"/"!=t.threadId&&e.index.includes(t.threadId)&&(a=t.threadId,d=e.index.indexOf(t.threadId)),C=function(t,n="nexus-tmp",e="/",a=-1){return{dataUrl:n,srcData:t,threadId:e,threadIndex:a}}(e,n,a,d)}(t),j=(0,d.gd)("UL","nx-edit-index"),A=(0,d.gd)("UL","nx-edit-local"),B=(0,d.gd)("UL","nx-edit-distant"),at(),N=(0,m.D)(C)[0];var n=(0,d.gd)("DIV");n.append(it());var e,a,r=(0,d.gd)("DIV");return r.append((0,d.rH)("local",null,[A],!1),(0,d.rH)("distant",null,[B],!1)),T=(0,d._$)([(a=(0,d.gd)("DIV","nx-edit-menu"),a.append(et(),(e=(0,d.gd)("DIV","nx-edit-actions nx-history-nav"),(0,d.Q$)(V,K),e.append(V.ctrls.prev.elm,V.ctrls.next.elm),e)),a)],[n,r],[],"edit"),(O=(0,d.gd)("BUTTON","nx-edit-switch")).textContent="👁",O.addEventListener("click",(function(){"✎"==O.textContent?(O.textContent="👁",(0,i.Mo)(N,T)):((0,c.f2)(C,!0,!0),O.textContent="✎",(0,i.Mo)(T,N))})),[T,O]}}}]);