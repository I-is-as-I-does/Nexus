{"version":3,"file":"js/NxViewer.js","mappings":";;;;;;;;;;;;;;;;;;;;;AAAA;AACuF;AACd;AACgB;AACnB;AACZ;AAC1D,YAAY,aAAa;AACyB;AACc;AAChE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP,IAAI,sFAAO,EAAE,mDAAmD;AAChE,QAAQ,uGAAa;AACrB,oBAAoB,wDAAW;AAC/B,QAAQ,4DAAc;AACtB;AACA,WAAW,uFAAQ;AACnB;AACA,eAAe,+DAAU;AACzB,UAAU;AACV;AACA,eAAe,+DAAS;AACxB;AACA;AACA;AACA;AACA,KAAK;AACL,QAAQ,oFAAM;AACd,iBAAiB,4FAAa,IAAI,+DAAS;AAC3C,OAAO;AACP;;;;;;;;;;;;;;;;;;;;;;;;;ACvCA;AACA;AAC0F;AACoB;AAC9G;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oBAAoB;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA,WAAW,uGAAqB;AAChC;AACA;AACA;AACA;AACO;AACP,eAAe,4FAAc;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP,SAAS,wFAAU;AACnB;AACA,GAAG;AACH;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ,qGAAmB;AAC3B;AACA;AACA;AACA,qCAAqC;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC9HA;AACyE;AACH;AACO;AACV;AACyB;AACV;AACR;AAC1E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,oFAAM;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA,uBAAuB,gGAAM;AAC7B,0GAAiB;AACjB;AACA;AACA;AACO;AACP;AACA,kBAAkB,oFAAM;AACxB;AACA;AACA;AACA;AACA,MAAM,2FAAW;AACjB;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB,gGAAM;AAC9B,IAAI,0GAAiB;AACrB;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACO;AACP;AACA,iCAAiC,4DAAe;AAChD,CAAC,8DAAiB;AAClB;AACA,GAAG;AACH;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA,IAAI,8DAAiB;AACrB;AACA,MAAM,uFAAS;AACf,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;AClSA;AACgG;AAEzD;AAIjB;AAC4D;AACjB;AACjE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,yBAAyB;AACtC,aAAa;AACb,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,YAAY,qDAAM;AAClB,EAAE,iEAAkB;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,aAAa,qDAAM;AACnB;AACA;AACA;AACA;AACA;AACA,MAAM,qFAAO;AACb,MAAM;AACN;AACA;AACA,MAAM,oFAAM;AACZ,MAAM,gGAAkB;AACxB;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,gBAAgB,qDAAM;AACtB,cAAc,qDAAM;AACpB;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,qDAAM;AACrB;AACA;AACA,CAAC,8DAAiB;AAClB;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA,IAAI,6FAAe;AACnB,MAAM,gGAAkB;AACxB,KAAK;AACL;AACA,IAAI,2DAAY;AAChB;AACA;AACA;AACA;AACA,QAAQ,4DAAe;AACvB,EAAE,sDAAS;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,2DAAY;AAC3B,EAAE,iEAAkB;AACpB;AACA;AACA;AACA,IAAI,0DAAa;AACjB;AACA,GAAG;AACH;AACA;AACA;AACA;AACO;AACP;AACA,SAAS,wDAAS;AAClB;;;;;;;;;;;;;;;;;;;;;;;;ACxIA;AACyE;AACO;AACN;AACkB;AACvB;AACrE;AACA;AACA;AACA;AACA,YAAY,gGAAa;AACzB;AACA,UAAU,mFAAO;AACjB,IAAI,4FAAS;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,SAAS,0DAAa;AAC1B;AACA;AACA;AACA;AACA;AACO;AACP,YAAY,qDAAM;AAClB;AACA;AACA;AACA;AACA,GAAG,8DAAiB;AACpB,MAAM,uFAAS;AACf,KAAK;AACL;AACA;AACA;AACA;AACO;AACP;AACA,mBAAmB,qDAAM;AACzB;AACA;AACA;AACA,eAAe,qDAAM;AACrB;AACA;AACA,GAAG;AACH,aAAa,qDAAM;AACnB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG,8DAAiB;AACpB;AACA,MAAM,uFAAS;AACf,KAAK;AACL;AACA;AACA;AACA;AACA;AACO;AACP,gBAAgB,qDAAM;AACtB;AACA,CAAC,8DAAiB;AAClB;AACA,GAAG;AACH;AACA;AACO;AACP,eAAe,2DAAY;AAC3B;AACA,IAAI,iEAAkB;AACtB;AACA;AACA;AACA;AACA;AACA,IAAI,0DAAa;AACjB,GAAG;AACH;AACA;AACA;AACO;AACP,aAAa,qDAAM;AACnB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0DAAa;AACb,GAAG;AACH;AACA;AACA;;;;;;;;;;;;;;;;;;;ACjHA;AAKsD;AACJ;AACe;AACkB;AACnF;AACA;AACA;AACA;AACA,WAAW,qDAAM;AACjB;AACA;AACA,CAAC,8DAAiB;AAClB,IAAI,8FAAgB;AACpB,GAAG;AACH;AACA;AACA;AACA;AACA,UAAU,qDAAM;AAChB;AACA,kBAAkB,gEAAiB;AACnC;AACA;AACA;AACA;AACA;AACA,cAAc,qDAAM;AACpB;AACA;AACA;AACA;AACA,oBAAoB,kBAAkB;AACtC;AACA;AACA;AACA;AACA,CAAC,8DAAiB;AAClB;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,iCAAiC;AACjC;AACA;AACA;AACA;AACA,WAAW,qDAAM;AACjB,YAAY,qDAAQ;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,qFAAO;AACb;AACA,OAAO;AACP;AACA,oBAAoB,WAAW;AAC/B;AACA;AACA,QAAQ,8FAAgB;AACxB;AACA,QAAQ;AACR;AACA;AACA;AACA;AACA;AACA,wBAAwB,WAAW;AACnC,MAAM,6FAAe;AACrB;AACA;AACA;AACA;AACO;AACP;AACA,oBAAoB,yDAAY,eAAe,sDAAS;AACxD;AACA,SAAS,wDAAS,mCAAmC,0DAAW;AAChE;;;;;;;;;;;;;;;;;;;AChGA;AACsE;AACxB;AACN;AACsC;AAC9E;AACA;AACA,SAAS,2DAAa;AACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,oFAAM;AACZ,KAAK;AACL,GAAG,6FAAY;AACf;AACA;AACA;AACO;AACP,iBAAiB,qDAAM;AACvB,cAAc,qDAAM;AACpB;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;AC/BA;AAC+E;AACiB;AAC7C;AACyC;AAC1C;AACgC;AAClF;AACA;AACA;AACA;AACA;AACA,WAAW,qDAAM;AACjB;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB,qDAAM;AACtB;AACA;AACA;AACA,EAAE,0GAAiB;AACnB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAY,qDAAM;AAClB;AACA;AACA;AACA,8DAAiB;AACjB;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,qFAAO;AACb,MAAM;AACN;AACA;AACA,MAAM,oFAAM;AACZ;AACA;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,qDAAM;AACpB;AACA;AACA;AACA;AACA;AACA;AACA,YAAY,qDAAM;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD,gGAAM;AAC3D;AACA;AACA;AACA,IAAI,6FAAe;AACnB,MAAM,6FAAe;AACrB,KAAK;AACL;AACA;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA,SAAS,wDAAS;AAClB;;;;;;;;;;;;;;;;;;;;;;;;AChHA;AAC6E;AAC6C;AAC1D;AAK1C;AACkB;AACgG;AAClE;AACa;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,yBAAyB;AACtC,aAAa;AACb,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oBAAoB,0DAAW;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,8FAAgB;AAClB,EAAE,8FAAgB;AAClB;AACA;AACA;AACA;AACA;AACA,cAAc,qDAAM;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS,wDAAS;AAClB;AACA;AACA;AACA,kBAAkB,6DAAc;AAChC;AACA;AACA;AACA,SAAS,wDAAS,gDAAgD,0DAAW;AAC7E;AACA;AACA;AACA,eAAe,qDAAM;AACrB;AACA;AACA;AACA;AACA,EAAE,2DAAY;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,qFAAO;AACX;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,6FAAe;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,8FAAgB;AACpB,IAAI;AACJ,IAAI,6FAAe;AACnB;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA,SAAS,qDAAM;AACf,cAAc,qDAAM;AACpB,CAAC,iEAAkB;AACnB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,4DAAe;AACnB,IAAI,sDAAS;AACb,IAAI,qDAAQ;AACZ;AACA,YAAY,qDAAM;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,oFAAM;AACV,GAAG;AACH,IAAI,qFAAO;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB,iGAAa;AACnC,mBAAmB,yDAAY;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,2DAAY;AAC1B;AACA;AACA,WAAW;AACX,YAAY,oFAAM;AAClB,WAAW;AACX;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ,2DAAY;AACpB;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,qDAAM;AACjB,0DAA0D,qDAAQ;AAClE;AACA;AACA;AACA;AACA,gBAAgB,qDAAM;AACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB,qDAAM;AACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B;AAC/B,oBAAoB,gBAAgB;AACpC;AACA;AACA,QAAQ,2FAAa;AACrB;AACA;AACA;AACA,OAAO;AACP,eAAe,gEAAiB;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;AACO;AACP,UAAU,qDAAM;AAChB;AACA;AACA;AACA;AACO;AACP;AACA;AACA;AACA;AACA;AACA;AACA,8DAAiB;AACjB;AACA,GAAG;AACH;AACA;AACA;;;;;;;;;;;;;;;;;;;;ACvSA;AACA;AAC8C;AACJ;AAEjB;AACmB;AACC;AAC7C;AACA;AACO;AACP;AACA,oBAAoB,qDAAM;AAC1B,qBAAqB,uDAAU;AAC/B,qBAAqB,qDAAM;AAC3B,yBAAyB,0DAAY;AACrC;AACA,YAAY,0DAAW;AACvB,EAAE,2DAAY;AACd;AACA;AACA,SAAS,yDAAW;AACpB","sources":["webpack://nexus/./src/NxStart.js","webpack://nexus/./src/NxState.js","webpack://nexus/./src/viewer/NxCommons.js","webpack://nexus/./src/viewer/NxHistory.js","webpack://nexus/./src/viewer/NxIdent.js","webpack://nexus/./src/viewer/NxIndex.js","webpack://nexus/./src/viewer/NxMedia.js","webpack://nexus/./src/viewer/NxSource.js","webpack://nexus/./src/viewer/NxThread.js","webpack://nexus/./src/viewer/NxViewer.js"],"sourcesContent":["/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { initAll, retrieveNxElm } from \"@i-is-as-i-does/nexus-core/src/load/NxInit.js\";\r\nimport { getQuery } from \"@i-is-as-i-does/nexus-core/src/base/NxHost.js\";\r\nimport { setOriginLang } from \"@i-is-as-i-does/nexus-core/src/transl/NxCoreTranslate.js\";\r\nimport { logErr } from \"@i-is-as-i-does/nexus-core/src/logs/NxLog.js\";\r\nimport { dataToState, setOriginState } from './NxState.js'\r\n// import { editorElms } from \"./editor/NxEditor.js\";\r\nimport { viewerElms } from \"./viewer/NxViewer.js\";\r\nimport { instanceWrap, errorPrgr } from \"./viewer/NxCommons.js\";\r\n\r\nconst appDefaultCss = 'https://cdn.jsdelivr.net/gh/I-is-as-I-does/Nexus@latest/dist/css/NexusI.min.css'\r\n\r\nfunction mountApp(nxElm, appElm){\r\n    var host = document.createElement('DIV');\r\n    host.className = \"nx\";\r\n    host.append(appElm)\r\n    nxElm.append(host)\r\n}\r\n\r\nexport function init(){\r\n    initAll({appDefaultLang: 'en', appDefaultCss: appDefaultCss}).then(seed => {\r\n        setOriginLang(seed.request.lang)\r\n        var state = dataToState(seed.request.url, seed.request.id, seed.nxdata)\r\n        setOriginState(state)\r\n        var elm;\r\n        if(getQuery(\"edit\")){\r\n         // elms = editorElms(state);\r\n         elm = viewerElms(state);\r\n        } else {\r\n         // elms = viewerElms(state);\r\n         elm = errorPrgr()\r\n        }\r\n\r\n      // mountApp(seed.nxelm, instanceWrap(elm))\r\n      mountApp(seed.nxelm, elm)\r\n    }).catch((err)=> {\r\n        logErr(err.message);\r\n        mountApp(retrieveNxElm(), errorPrgr())\r\n      })\r\n}","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\n\r\nimport { getSrcData, getThreadsList } from \"@i-is-as-i-does/nexus-core/src/load/NxSrc.js\";\r\nimport { isThreadContentUnseen, registerThreadVisit } from \"@i-is-as-i-does/nexus-core/src/storg/NxMemory.js\";\r\n\r\nconst bufferTime = 400;\r\nvar currentState = {\r\n      dataUrl: null,\r\n      srcData: null,\r\n      threadId: \"/\",\r\n      threadIndex: -1\r\n    };\r\n    \r\nvar updateStore = { onChange: [], onSrcChange: [] };\r\nvar updateRunning = false;\r\n\r\nfunction triggerCallbacks(state,triggerAll) {\r\n  var ks = [\"onChange\"];\r\n  if (triggerAll) {\r\n    ks.push(\"onSrcChange\");\r\n  }\r\n\r\n  ks.forEach((k) => {\r\n    if (updateStore[k].length) {\r\n     updateStore[k].forEach((callback) => {\r\n        callback(state);\r\n      });\r\n    }\r\n  });\r\n}\r\n\r\nfunction updateTimeout() {\r\n  setTimeout(\r\n    function () {\r\n      updateRunning = false;\r\n    },\r\n    bufferTime\r\n  );\r\n}\r\n\r\nexport function concatSrc(state){\r\n  var src = state.dataUrl\r\n  if(state.threadId !== '/'){\r\n    src += '#'+state.threadId\r\n  }\r\n return src\r\n}\r\n\r\nexport function getTimestamp(state){\r\n  if (state.threadIndex !== -1) {\r\nreturn state.srcData.threads[state.threadIndex].content.timestamp\r\n  }\r\n  return null\r\n}\r\n\r\nexport function isStateUnseen(state){\r\n  if (state.threadId !== '/') {\r\n    return isThreadContentUnseen(concatSrc(state), getTimestamp(state))\r\n  }\r\n  return false\r\n}\r\n\r\nexport function dataToState(dataUrl, threadId, data){\r\n  data.index = getThreadsList(data)\r\n    var state = {\r\n      dataUrl: dataUrl,\r\n      threadId: threadId,\r\n      srcData: data,\r\n      threadIndex: data.index.indexOf(threadId)\r\n    };\r\n\r\n    if (state.threadIndex === -1 && threadId !== \"/\") {\r\n      state.threadId = \"/\";\r\n    }\r\n    return state;\r\n}\r\n\r\nexport function resolveState(dataUrl, threadId) {\r\n  return getSrcData(dataUrl).then((data) => {\r\n  return dataToState(dataUrl, threadId, data)\r\n  });\r\n}\r\n\r\nexport function registerUpdateEvt(callback, onSrcChange = false) {\r\n  var k = \"onChange\";\r\n  if (onSrcChange) {\r\n    k = \"onSrcChange\";\r\n  }\r\n  updateStore[k].push(callback);\r\n}\r\n\r\nexport function triggerUpdate(state, skipHistoryUpdate = false, forceTrigger = false) {\r\n  if (!updateRunning) {\r\n    var srcChanged = state.dataUrl != currentState.dataUrl;\r\n\r\n    if (forceTrigger || srcChanged || state.threadId != currentState.threadId) {\r\n      updateRunning = true;\r\n      if (!skipHistoryUpdate && currentState.threadId !== '/') {\r\n        registerThreadVisit(concatSrc(currentState), getTimestamp(currentState));\r\n      }\r\n    \r\n      var resetIndex = srcChanged || forceTrigger;\r\n      currentState = Object.assign({},state);\r\n\r\n      triggerCallbacks(state, resetIndex);\r\n      updateTimeout();\r\n    }\r\n  }\r\n}\r\n\r\nexport function getCurrentState() {\r\n  return currentState;\r\n}\r\n\r\nexport function setOriginState(state) {\r\n  if (!currentState.dataUrl) {\r\n    currentState = state;\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function getBuffertime(){\r\n  return bufferTime;\r\n}\r\n\r\n\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { splitFlap } from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { getErr } from \"@i-is-as-i-does/nexus-core/src/logs/NxLog.js\";\r\nimport { isCssLoaded } from \"@i-is-as-i-does/nexus-core/src/load/NxStyle.js\";\r\nimport { getCurrentState, registerUpdateEvt } from \"../NxState.js\";\r\nimport { registerTranslElm } from \"@i-is-as-i-does/nexus-core/src/transl/NxElmTranslate.js\";\r\nimport { getTxt } from \"@i-is-as-i-does/nexus-core/src/transl/NxCoreTranslate.js\";\r\nimport { appUrl } from \"@i-is-as-i-does/nexus-core/src/validt/NxSpecs.js\";\r\n\r\n\r\nfunction resolveThreadTitle(state) {\r\n  var threadTitle = \"/\";\r\n  if (state.threadId && state.threadId != \"/\") {\r\n    threadTitle = state.srcData.threads[state.threadIndex].title;\r\n  }\r\n  return threadTitle;\r\n}\r\n\r\n\r\nfunction toggleOnDisplay(viewlk, givenState, newState) {\r\n  if (newState.dataUrl && givenState.dataUrl == newState.dataUrl && givenState.threadId == newState.threadId) {\r\n    viewlk.classList.add(\"nx-on-display\");\r\n  } else {\r\n    viewlk.classList.remove(\"nx-on-display\");\r\n  }\r\n}\r\n\r\n\r\nfunction appHeader() {\r\n  var header = getElm('HEADER');\r\n  header.append(appLink());\r\n  return header;\r\n}\r\n\r\n\r\nfunction appLink() {\r\n  var link = getElm(\"A\", \"nx-app-link nx-external-link\");\r\n  link.target = \"_blank\";\r\n  link.href = appUrl;\r\n  link.title = \"Nexus\";\r\n  link.textContent = \"Nexus\";\r\n  return link;\r\n}\r\n\r\n\r\nfunction appMain(serviceElms){\r\nvar main = getElm('MAIN');\r\nmain.append(...serviceElms);\r\nreturn main;\r\n}\r\n\r\nexport function getElm(tag, classList) {\r\n  var elm = document.createElement(tag);\r\n  if (classList) {\r\n    elm.className = classList; \r\n  }\r\n  return elm;\r\n}\r\n\r\nexport function instanceWrap(serviceElms){\r\n  var inst = getElm(\"DIV\", \"nx-instance\");\r\n  inst.append(appHeader(), appMain(serviceElms));\r\n  return inst;\r\n}\r\n\r\nexport function serviceWrap\r\n(navElms, mainElms, footerElms = [], service = 'viewer') {\r\n  var wrap = getElm(\"DIV\", \"nx-\"+service);\r\n  var nav = getElm(\"NAV\");\r\n  nav.append(...navElms);\r\n  var bd = getElm(\"SECTION\");\r\n  bd.append(...mainElms);\r\n  wrap.append(nav, bd);\r\n  if(footerElms.length){\r\n    var footer = getElm(\"FOOTER\");\r\n    footer.append(...footerElms);\r\n    wrap.append(footer);\r\n  }\r\n  return wrap;\r\n}\r\n\r\nexport function blockWrap(\r\n  blockName,\r\n  headerElms = null,\r\n  contentElms = null,\r\n  landmark = false\r\n) {\r\n  var dv = getElm(\"DIV\", \"nx-\" + blockName + \" nx-block\");\r\n  if (landmark) {\r\n    dv.append(landmark);\r\n  }\r\n  if (headerElms) {\r\n    var header = getElm(\"DIV\",\"nx-thread-header\");\r\n    header.append(...headerElms);\r\n    dv.append(header);\r\n  }\r\n  if (contentElms) {\r\n    dv.append(...contentElms);\r\n  }\r\n  return dv;\r\n}\r\n\r\nexport function landmarkElm(name) {\r\n  var lndmrk = getElm(\"SPAN\", \"nx-landmark nx-landmark-\"+name.replace(\" \", \"-\"));\r\n  lndmrk.textContent = getTxt(name);\r\nregisterTranslElm(lndmrk, name);\r\n  return lndmrk;\r\n}\r\n\r\nexport function errorPrgr() {\r\n\r\n    var errMsgs = getErr();\r\n    if(!errMsgs.length){\r\n      errMsgs = [\"Init failed\"];\r\n    }\r\n  var p = getElm(\"P\");\r\n  if (isCssLoaded()) {\r\n    p.className = \"nx-error\";\r\n  } else {\r\n    p.style.margin = \"0 auto\";\r\n    p.style.fontFamily = '\"Courier New\", Courier, monospace';\r\n    p.style.fontSize = \"13px\";\r\n  }\r\n\r\n    var br = getElm('BR');\r\n    var sp1 = getElm(\"SPAN\");\r\n    sp1.textContent = \"—/ — \";\r\n    p.append(sp1, br);\r\n    errMsgs.forEach((msg) => {\r\n      var spx = getElm(\"SPAN\");\r\n      spx.textContent = getTxt(msg);\r\n    registerTranslElm(spx, msg);\r\n      p.append(spx, br.cloneNode());\r\n    });\r\n  \r\n  return p;\r\n}\r\n\r\n\r\nexport function toggleNavEnd(map) {\r\n\r\n  if (map.position > 0) {\r\n    map.ctrls[\"prev\"].elm.classList.remove(\"nx-nav-end\");\r\n  } else {\r\n    map.ctrls[\"prev\"].elm.classList.add(\"nx-nav-end\");\r\n  }\r\n  if (map.position < map.count-1) {\r\n    map.ctrls[\"next\"].elm.classList.remove(\"nx-nav-end\");\r\n  } else {\r\n    map.ctrls[\"next\"].elm.classList.add(\"nx-nav-end\");\r\n  }\r\n}\r\n\r\n\r\nexport function setHistoryControls(map, triggerCallback){\r\n  Object.keys(map.ctrls).forEach((ctrl) => {\r\n    map.ctrls[ctrl].elm = getElm(\"A\", \"nx-nav-ctrl nx-nav-end\");\r\n    map.ctrls[ctrl].elm.textContent = map.ctrls[ctrl].symbol;\r\n    map.ctrls[ctrl].elm.addEventListener(\"click\", function () {\r\n      if (!map.ctrls[ctrl].elm.classList.contains(\"nx-nav-end\")) {\r\n        if (ctrl == \"next\") {\r\n          map.position++;\r\n        } else {\r\n          map.position--;\r\n        }\r\n        triggerCallback(ctrl);\r\n        toggleNavEnd(map);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nexport function selectDropDown(list, toggleElm, actionCallback = null, switchClass = null){\r\n  var selectedClass = \"nx-selected\";\r\n  toggleElm.classList.add('nx-select-toggle');\r\n  var isInput = toggleElm.tagName == 'INPUT';\r\n  var firstValue;\r\n  if(isInput){\r\n    toggleElm.setAttribute(\"autocomplete\",\"off\");\r\n    firstValue = toggleElm.value;\r\n  } else {\r\n    firstValue = toggleElm.textContent;\r\n  }\r\n\r\n\r\n  var drp = getElm(\"UL\", \"nx-select-list\");\r\n  \r\n  var swtch = getElm(\"DIV\", \"nx-select\");\r\n  if(switchClass){\r\n    swtch.classList.add(switchClass);\r\n  }\r\n  swtch.append(toggleElm, drp);\r\n\r\n  toggleElm.addEventListener(\"click\", () => {\r\n    var styl = \"none\";\r\n    if (drp.style.display == styl) {\r\n      styl = \"block\";\r\n    }\r\n    drp.style.display = styl;\r\n  });\r\n  \r\n  list.forEach((itm) => {\r\n\r\n    var li = getElm(\"LI\");\r\n    li.textContent = itm;\r\n    li.dataset.item = itm;\r\n    if (itm == firstValue) {\r\n      li.classList.add(selectedClass);\r\n    }\r\n    \r\n    drp.append(li);\r\n    li.addEventListener(\"click\", () => {   \r\n      var nitm = li.textContent;\r\n      var currVal;\r\n      if(isInput){\r\n        currVal = toggleElm.value;\r\n       } else {\r\n        currVal = toggleElm.textContent;\r\n       }\r\n       if(currVal != nitm){\r\n        if(!li.classList.contains(selectedClass)){      \r\n          var prev = drp.querySelector(\".\" + selectedClass);\r\n          if(prev){\r\n            prev.classList.remove(selectedClass);\r\n          }         \r\n          li.classList.add(selectedClass);\r\n        }\r\n        if(isInput){\r\n          toggleElm.value = nitm;\r\n         } else {\r\n         toggleElm.textContent = nitm;\r\n         }\r\n         toggleElm.dispatchEvent(new window.Event('change'));\r\n        if (typeof actionCallback === \"function\") {\r\n          actionCallback(nitm);\r\n        }\r\n       }\r\n\r\n      drp.style.display = \"none\";\r\n    });\r\n\r\n  });\r\n  drp.style.display = \"none\";\r\n\r\n  return swtch;\r\n}\r\n\r\nexport function convertLineBreaks(text){\r\n  return text.replace(/(\\r\\n|\\n|\\r)/gm, \"<br>\");\r\n}\r\n\r\nexport function setToggleOnDisplay(viewlk, state) {\r\n\r\n  toggleOnDisplay(viewlk, state, getCurrentState());\r\n registerUpdateEvt(function (newState) {\r\n    toggleOnDisplay(viewlk, state, newState);\r\n  });\r\n}\r\n\r\nexport function baseViewLink(state, update = false) {\r\n  var viewlk = getElm(\"A\", \"nx-view-link\");\r\n  viewlk.append(threadTitleElm(state, update));\r\n  return viewlk;\r\n}\r\n\r\nexport function threadTitleElm(state, update = false) {\r\n  var sp = getElm(\"SPAN\", \"nx-thread-title\");\r\n  sp.textContent = resolveThreadTitle(state);\r\n  if (update) {\r\n    registerUpdateEvt(function (newState) {\r\n      var newThreadTitle = resolveThreadTitle(newState);\r\n      splitFlap(sp, newThreadTitle, 15);\r\n    });\r\n  }\r\n\r\n  return sp;\r\n}\r\n\r\n\r\nexport function viewerInstance(state){\r\n  var indexPart = getElm(\"DIV\");\r\n  indexPart.append(indexBlock(state));\r\n  var threadPart = getElm(\"DIV\");\r\n  threadPart.append(...threadBlocks(state));\r\n  \r\n  return serviceWrap\r\n([appBlock(), historyBlock(state)], [\r\n   indexPart,\r\n   threadPart\r\n   ], [sourceBlock(state)]);\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { easeIn, easeOut, insertDiversion } from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { blockWrap, getElm, setHistoryControls, toggleNavEnd,setToggleOnDisplay,\r\n  baseViewLink } from \"./NxCommons.js\";\r\nimport {\r\n  authorIndexLink,\r\n  authorUrl\r\n} from \"./NxIdent.js\";\r\nimport { autoScrollToBottom } from \"@i-is-as-i-does/jack-js/src/modules/Style.js\";\r\nimport { registerUpdateEvt, triggerUpdate } from \"../NxState.js\";\r\n\r\nconst historyMax = 100;\r\nvar isHistoryEvent = false;\r\nvar historyList = null;\r\nvar historyElm = null;\r\n\r\nvar historyState = {\r\n  dataUrl: null,\r\n  srcData: null,\r\n  threadId: \"/\",\r\n  threadIndex: -1\r\n};\r\n\r\nvar histCtrls = {\r\n  \"ctrls\":{\r\n    \"prev\": {\"symbol\":\"<\", \"elm\":null},\r\n    \"next\": {\"symbol\":\">\", \"elm\":null}\r\n  },\r\n   position:0,\r\n   count:1\r\n }\r\n\r\n\r\nfunction historyNav() {\r\n  var wrp = getElm(\"DIV\", \"nx-history-nav\");\r\n  setHistoryControls(histCtrls, function(ctrl){\r\n    var postn = histCtrls.position;\r\n    if(ctrl == 'prev'){\r\n      postn += 1;\r\n    }\r\n    var target =\r\n    historyList.children[postn].querySelector(\r\n      \".nx-thread-title\"\r\n    );\r\n  target.click();\r\n  });\r\n  wrp.append(histCtrls.ctrls[\"prev\"].elm,historyToggleElm(),histCtrls.ctrls[\"next\"].elm);\r\n  return wrp;\r\n}\r\nfunction historyToggleElm() {\r\n  var tggl = getElm(\"A\", \"nx-history-toggle\");\r\n  tggl.textContent = \"≚\";\r\n  tggl.addEventListener(\"click\", () => {\r\n    if (tggl.textContent == \"≙\") {\r\n      tggl.textContent = \"≚\";\r\n      tggl.classList.remove(\"nx-active\");\r\n      easeOut(historyElm, 200);\r\n    } else {\r\n      tggl.textContent = \"≙\";\r\n      tggl.classList.add(\"nx-active\");\r\n      easeIn(historyElm, 200);\r\n      autoScrollToBottom(historyList);\r\n    }\r\n  });\r\n  return tggl;\r\n}\r\n\r\nfunction setHistoryListElm(state) {\r\n\r\n  historyList = getElm(\"UL\", \"nx-history-list\");\r\n  var first = getElm(\"LI\");\r\n  first.textContent = \"...\";\r\n  historyList.append(first);\r\n  if(state && state.srcData){\r\n  historyState = state;\r\n  historyList.append(historyItm(state));\r\n}\r\n  historyElm = getElm(\"DIV\", \"nx-history-drawer\");\r\n  historyElm.append(historyList);\r\n  historyElm.style.display = \"none\";\r\n registerUpdateEvt(function (newState) {\r\n    historyEvent(newState);\r\n  });\r\n\r\n}\r\n\r\n\r\nfunction historyEvent(state) {\r\n\r\n  if (!isHistoryEvent && (state.dataUrl != historyState.dataUrl || state.threadId != historyState.threadId)) {\r\n    historyState = state;\r\n    if (histCtrls.count > historyMax) {\r\n      historyList.children[1].remove();      \r\n    } else {\r\n      histCtrls.count++;\r\n    }\r\n\r\n    histCtrls.position = histCtrls.count-1;\r\n    var itm = historyItm(state);\r\n    insertDiversion(historyList, itm, false, true, 200, function () {\r\n      autoScrollToBottom(historyList);\r\n    });\r\n\r\n    toggleNavEnd(histCtrls);\r\n  }\r\n}\r\n\r\nfunction viewElms(state){\r\nreturn [authorIndexLink(state, false),\r\n  authorUrl(state, false),\r\n  historyViewLink(state, false)];\r\n}\r\n\r\nfunction historyItm(state) {\r\n\r\n  var itm = document.createElement(\"LI\");\r\n    itm.append(...viewElms(state));\r\n  return itm;\r\n}\r\n\r\nfunction historyViewLink(state) {\r\n  var viewlk = baseViewLink(state, false);\r\n  setToggleOnDisplay(viewlk, state);\r\n\r\n  viewlk.addEventListener(\"click\", () => {\r\n    isHistoryEvent = true;\r\n    triggerUpdate(state, true);\r\n    isHistoryEvent = false;\r\n  });\r\n  return viewlk;\r\n}\r\n\r\n\r\nexport function historyBlock(state) {\r\n  setHistoryListElm(state);\r\n  return blockWrap(\"history\", null, [historyNav(), historyElm], false);\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { splitFlap } from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { registerUpdateEvt, triggerUpdate, isStateUnseen } from \"../NxState.js\";\r\nimport { baseViewLink, getElm, setToggleOnDisplay } from \"./NxCommons.js\";\r\nimport { getStoredItem, storeItem } from '@i-is-as-i-does/nexus-core/src/storg/NxStorage.js'\r\nimport { miniUrl } from \"@i-is-as-i-does/jack-js/src/modules/Web.js\";\r\n\r\nvar urlStore = {}\r\n\r\nfunction authorMiniUrl(authorUrl) {\r\n  var url = getStoredItem(authorUrl,\"local\",urlStore, false);\r\n  if(!url){\r\n    url = miniUrl(authorUrl);\r\n    storeItem(authorUrl, url, \"local\", urlStore,false);\r\n  }\r\n  return url;\r\n}\r\n\r\n\r\nfunction toggleUnseen(viewlk, state) {\r\n  if (viewlk.classList.contains(\"nx-on-display\")) {\r\n    viewlk.classList.remove(\"nx-unseen\");\r\n    viewlk.lastChild.textContent = \"\";\r\n  } else if (isStateUnseen(state)) {\r\n    viewlk.classList.add(\"nx-unseen\");\r\n    viewlk.lastChild.textContent = \"*\";\r\n  }\r\n}\r\n\r\nexport function authorHandle(state, update = false) {\r\n  var hnd = getElm(\"SPAN\", \"nx-handle\");\r\n  if(state.srcData){\r\n  hnd.textContent = state.srcData.author.handle;\r\n}\r\n  if (update) {\r\n   registerUpdateEvt(function (newState) {\r\n      splitFlap(hnd, newState.srcData.author.handle, 20);\r\n    }, true);\r\n  }\r\n  return hnd;\r\n}\r\n\r\nexport function authorUrl(state, update = false) {\r\n\r\n  var authorlksp = getElm(\"SPAN\",\"nx-author-url\");\r\n \r\n  var urlBrck = [];\r\n  [\"[\", \"]\"].forEach((bracket) => {\r\n    var brsp = getElm(\"SPAN\", \"nx-author-url-brackets\");\r\n    brsp.textContent = bracket;\r\n    urlBrck.push(brsp);\r\n  });\r\n  var urla = getElm(\"A\", \"nx-external-link\");\r\n  urla.target = \"_blank\";\r\n  var hrf = '';\r\n  if(state.srcData){\r\n hrf = state.srcData.author.url;\r\n  }\r\n  urla.href =hrf;\r\n  \r\n  if(state.srcData){\r\n    urla.textContent = authorMiniUrl(state.srcData.author.url);\r\n  }\r\n  \r\n  authorlksp.append(urlBrck[0], urla, urlBrck[1]);\r\n\r\n  if (update) {\r\n   registerUpdateEvt(function (newState) {\r\n      urla.href = newState.srcData.author.url;\r\n      splitFlap(urla, authorMiniUrl(newState.srcData.author.url), 20);\r\n    }, true);\r\n  }\r\n  return authorlksp;\r\n}\r\n\r\n\r\nexport function setToggleUnseen(viewlk, state) {\r\n  viewlk.append(getElm(\"SPAN\", \"nx-new-tag\"));\r\n  toggleUnseen(viewlk, state);\r\n registerUpdateEvt(function () {\r\n    toggleUnseen(viewlk, state);\r\n  });\r\n}\r\n\r\nexport function viewLink(state, update = false) {\r\n  var viewlk = baseViewLink(state, update);\r\n  if (state.threadId != \"/\") {\r\n    setToggleOnDisplay(viewlk, state);\r\n    setToggleUnseen(viewlk, state);\r\n  }\r\n\r\n  viewlk.addEventListener(\"click\", () => {\r\n \r\n    triggerUpdate(state);\r\n  });\r\n  return viewlk;\r\n}\r\n\r\nexport function authorIndexLink(state, update = false) {\r\n  var auth = getElm(\"A\", \"nx-author-link\");\r\n  auth.append(authorHandle(state, update));\r\n\r\n  var newState = {\r\n    dataUrl: state.dataUrl,\r\n    srcData: state.srcData,\r\n    threadId: \"/\",\r\n    threadIndex: -1\r\n  };\r\n  auth.addEventListener(\"click\", function () {\r\ntriggerUpdate(newState, \"/\");\r\n  });\r\n\r\n  return auth;\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport {\r\n  easeOut,\r\n  insertDiversion,\r\n  replaceDiversion,\r\n} from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { registerUpdateEvt } from \"../NxState.js\";\r\nimport { authorHandle, authorUrl, viewLink } from \"./NxIdent.js\";\r\nimport { blockWrap, convertLineBreaks, getElm, landmarkElm } from \"./NxCommons.js\";\r\n\r\nvar indexList = null;\r\n\r\nfunction aboutElm(state) {\r\n  var ab = getElm(\"DIV\", \"nx-about-author\");\r\n\r\n  ab.append(aboutParagraph(state));\r\n registerUpdateEvt(function (newState) {\r\n    replaceDiversion(ab.firstChild, aboutParagraph(newState));\r\n  }, true);\r\n  return ab;\r\n}\r\n\r\nfunction aboutParagraph(state) {\r\n  var p = getElm(\"P\");\r\n  if(state.srcData){\r\n  p.textContent = convertLineBreaks(state.srcData.author.about);\r\n}\r\n  return p;\r\n}\r\n\r\nfunction setIndexList(state) {\r\n  indexList = getElm(\"UL\");\r\n  if(state.srcData){\r\n  var items = state.srcData.index;\r\n\r\n  if (items.length) {\r\n    for (var i = 0; i < items.length; i++) {\r\n      indexList.append(indexLi(state, items[i], i));\r\n    }\r\n  }\r\n}\r\n registerUpdateEvt(function (newState) {\r\n\r\n    changeThreadsList(newState);\r\n  }, true);\r\n\r\n}\r\n\r\nfunction indexLi(state, id, index) {\r\n  var altState = Object.assign({}, state);\r\n\r\n  altState.threadId = id;\r\n  altState.threadIndex = index;\r\n\r\n  var li = getElm(\"LI\");\r\n  li.append(viewLink(altState, false));\r\n  return li;\r\n}\r\n\r\nfunction changeThreadsList(state) {\r\n\r\n  var childr = indexList.childNodes;\r\n  var items = state.srcData.index;\r\n  var nwlen = items.length;\r\n\r\n  var chlen = childr.length;\r\n\r\n  var count = 0;\r\n  if (chlen) {\r\n    var rmv = function (child) {\r\n      easeOut(child, 200, function () {\r\n        child.remove();\r\n      });\r\n    };\r\n    for (var x = 0; x < chlen; x++) {\r\n      if (nwlen > x) {\r\n        var nlink = indexLi(state, items[x], x);\r\n        replaceDiversion(childr[x], nlink);\r\n        count++;\r\n      } else {\r\n        rmv(childr[x]);\r\n      }\r\n    }\r\n  }\r\n  if (count < nwlen) {\r\n    for (var y = count; y < nwlen; y++) {\r\n      insertDiversion(indexList, indexLi(state, items[y], y), false, true, 200);\r\n    }\r\n  }\r\n}\r\n\r\nexport function indexBlock(state) {\r\n  setIndexList(state);\r\n  var headerElms = [authorHandle(state, true), authorUrl(state, true)];\r\n  var contentElms = [aboutElm(state), indexList];\r\n  return blockWrap(\"index\", headerElms, contentElms, landmarkElm(\"index\"));\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { easeIn } from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { threadTextElm } from \"./NxThread.js\";\r\nimport { getElm } from \"./NxCommons.js\";\r\nimport { resolveMedia } from \"@i-is-as-i-does/nexus-core/src/data/NxMedia.js\";\r\n\r\nfunction threadMediaCaption(threadData) {\r\n  return threadTextElm(threadData, [\"content\", \"media\", \"caption\"]);\r\n}\r\n\r\nfunction setThreadMedia(mediaWrap, threadData) {\r\n  mediaWrap.style.display = 'none'\r\n  if (threadData && threadData.content.media.type) {   \r\n    mediaWrap.addEventListener('mediaReady', function(){\r\n      if(mediaWrap.firstChild.tagName === 'A' && threadData.content.media.type !== 'page'){\r\n        threadData.content.media.type = 'page';\r\n      }\r\n      mediaWrap.className = \"nx-\" + threadData.content.media.type + \"-media\";\r\n      easeIn(mediaWrap, 200)\r\n    })\r\n   resolveMedia(threadData.content.media.url, threadData.content.media.type, mediaWrap)\r\n  }\r\n}\r\n\r\nexport function mediaElm(mediaWrap, threadData) {\r\n  var mediadiv = getElm(\"DIV\", \"nx-content-media\");\r\n  mediaWrap = getElm(\"DIV\");\r\n  setThreadMedia(threadData);\r\n  mediadiv.append(mediaWrap, threadMediaCaption(threadData));\r\n\r\n  return mediadiv;\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { copyToClipboard } from \"@i-is-as-i-does/jack-js/src/modules/Stock.js\";\r\nimport { timedFadeToggle, easeOut, easeIn } from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { blockWrap, getElm } from \"./NxCommons.js\";\r\nimport { registerTranslElm } from \"@i-is-as-i-does/nexus-core/src/transl/NxElmTranslate.js\";\r\nimport { registerUpdateEvt } from \"../NxState.js\";\r\nimport { getTxt } from \"@i-is-as-i-does/nexus-core/src/transl/NxCoreTranslate.js\";\r\n\r\nvar drawerElm = null;\r\nvar editMode = false;\r\n\r\nfunction actionLink(action, text) {\r\n  var lk = getElm(\"A\", \"nx-source-\" + action);\r\n  lk.textContent = text;\r\n  return lk;\r\n}\r\n\r\n\r\nfunction toolTip(className, text) {\r\n  var tooltip = getElm(\"SPAN\", className);\r\n  tooltip.textContent = text;\r\n  tooltip.style.opacity = 0;\r\n  tooltip.hidden = true;\r\n  registerTranslElm(tooltip, text);\r\n  return tooltip;\r\n}\r\n\r\nfunction resolveSrc(state){\r\n  var src = state.dataUrl;\r\n  if(editMode){\r\n    src = \"edit\";\r\n  }\r\n  if(state.threadId !== \"/\"){\r\n    src += \"#\"+state.threadId;\r\n  }\r\n  \r\n  return src;\r\n}\r\nfunction instanceUrl(state){\r\n  var elm = getElm(\"INPUT\", \"nx-instance-url\");\r\n  elm.type=\"text\";\r\n  elm.value = resolveSrc(state);\r\n\r\nregisterUpdateEvt(function (newState) {\r\n  elm.value = resolveSrc(newState);\r\n  });\r\n  return elm;\r\n}\r\n\r\n\r\nfunction toggleLink() {\r\n  var text = \"</>\";\r\n  var altText = \"< />\";\r\n  var lk = actionLink(\"drawer\", text);\r\n\r\n  lk.addEventListener(\"click\", () => {\r\n    if (lk.textContent == altText) {\r\n      lk.textContent = text;\r\n      lk.classList.remove(\"nx-active\");\r\n      easeOut(drawerElm, 200);\r\n    } else {\r\n      lk.textContent = altText;\r\n      lk.classList.add(\"nx-active\");\r\n      easeIn(drawerElm, 100, function () {\r\n        drawerElm.scrollIntoView({\r\n          block: \"end\",\r\n          behavior: \"smooth\",\r\n          inline: \"nearest\",\r\n        });\r\n      });\r\n    }\r\n  });\r\n  return lk;\r\n}\r\n\r\n\r\n\r\nfunction linkBundle(state) {\r\n  drawerElm = getElm(\"DIV\", \"nx-source-drawer\");\r\n  var url = instanceUrl(state);\r\n  var copylk = copyLink(url);\r\n    drawerElm.append(url, copylk);\r\n\r\n  drawerElm.style.display = \"none\";\r\n\r\n  var tgg = getElm(\"DIV\", \"nx-source-toggle\");\r\n  var snippetLink = toggleLink();\r\n  tgg.append(snippetLink);\r\n\r\n  return [tgg, drawerElm];\r\n}\r\n\r\n\r\nfunction copyLink(elm) {\r\n  var copyLk = actionLink(\"copy\", \"⧉\");\r\n  var copyTooltip = toolTip(\"nx-source-copy-tooltip\",getTxt(\"copied\"));\r\n  copyLk.append(copyTooltip);\r\n\r\n  copyLk.addEventListener(\"click\", () =>\r\n    copyToClipboard(elm.textContent, () => {\r\n      timedFadeToggle(copyTooltip, 1000);\r\n    })\r\n  );\r\n  return copyLk;\r\n}\r\n\r\n\r\nexport function sourceBlock(state, editionSource = false) {\r\n  if(editionSource){\r\n    editMode = true;\r\n  }\r\n  return blockWrap(\"source\", null, linkBundle(state), false);\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\nimport { isNonEmptyStr } from \"@i-is-as-i-does/jack-js/src/modules/Check.js\";\r\nimport {easeOut, fadeIn, fadeOut, insertDiversion, replaceDiversion } from \"@i-is-as-i-does/valva/src/modules/aliases.js\";\r\nimport { registerUpdateEvt, resolveState } from \"../NxState.js\";\r\nimport {\r\n  authorIndexLink,\r\n  authorUrl,\r\n  viewLink,\r\n} from \"./NxIdent.js\";\r\nimport { mediaElm } from \"./NxMedia.js\";\r\nimport { blockWrap, convertLineBreaks, getElm,  landmarkElm,  setHistoryControls,  threadTitleElm, toggleNavEnd } from \"./NxCommons.js\";\r\nimport { logErr } from \"@i-is-as-i-does/nexus-core/src/logs/NxLog.js\";\r\nimport { splitUrlAndId } from \"@i-is-as-i-does/nexus-core/src/validt/NxStamper.js\";\r\n\r\nvar currentElm;\r\nvar descrpElm;\r\nvar contentElm;\r\n\r\nvar slider;\r\n\r\nvar linked = [];\r\n\r\nvar linkedCtrls = {\r\n  \"ctrls\":{\r\n    \"prev\": {\"symbol\":\"⊼\", \"elm\":null},\r\n    \"next\": {\"symbol\":\"⊻\", \"elm\":null}\r\n  },\r\n   position:0,\r\n   count:0\r\n }\r\n\r\n var distantLandmark;\r\n\r\n function setDistantLandmark(){\r\n  distantLandmark = landmarkElm(\"distant\");\r\n  distantLandmark.style.display =\"none\";\r\n }\r\n\r\n\r\nfunction updateThreadBlocks(state) {\r\n  var newThreadData = resolveThreadData(state);\r\n\r\n  var newContent = threadContent(newThreadData);\r\n  var newDescrpTxt = threadTextElm(newThreadData, [\"description\"]);\r\n  replaceDiversion(descrpElm.firstChild, newDescrpTxt);\r\n  replaceDiversion(contentElm.firstChild, newContent);\r\n\r\n  resetDistantLinks(newThreadData);\r\n}\r\n\r\nfunction setDescriptionElm(threadData) {\r\n  descrpElm = getElm(\"DIV\", \"nx-thread-description\");\r\n  descrpElm.append(threadTextElm(threadData, [\"description\"]));\r\n}\r\n\r\nfunction resolveThreadData(state) {\r\n  var threadData = null;\r\n  if (state.threadId && state.threadId != \"/\") {\r\n    threadData = state.srcData.threads[state.threadIndex];\r\n  }\r\n  return threadData;\r\n}\r\nfunction distantThreadBlock(threadData) {\r\n  setDistantLandmark();\r\n  setDistantSlider();\r\n  setLinkedItems(threadData);\r\n  return blockWrap(\"distant\", null, [slider], distantLandmark);\r\n}\r\n\r\nfunction localThreadBlock(state, threadData) {\r\n  var headerElm = threadTitleElm(state, true);\r\n  setDescriptionElm(threadData);\r\n  setContentElm(threadData);\r\n\r\n  return blockWrap(\"local\", [headerElm], [descrpElm, contentElm], landmarkElm(\"local\"));\r\n}\r\n\r\nfunction setContentElm(threadData) {\r\n  contentElm = getElm(\"DIV\", \"nx-local-content\");\r\n  contentElm.append(threadContent(threadData));\r\n}\r\n\r\nfunction hideDistantNav(){\r\n  toggleNavEnd(linkedCtrls);\r\n \r\n  linkedCtrls.ctrls[\"next\"].elm.style.visibility = 'hidden';\r\n  linkedCtrls.ctrls[\"prev\"].elm.style.visibility = 'hidden';\r\n}\r\n\r\nfunction resetDistantLinks(threadData){\r\n\r\n  linked = [];\r\n   linkedCtrls.position = 0;\r\n  linkedCtrls.count = 0;\r\n\r\n  hideDistantNav();\r\n  removeDistantContent();\r\n  toggleDistantLandmark(false);\r\n  setLinkedItems(threadData);\r\n}\r\n\r\nfunction setPrevCtrlVisb(){\r\n  if(linkedCtrls.position === 0){\r\n    linkedCtrls.ctrls[\"prev\"].elm.style.visibility = 'hidden';\r\n  } else if(linkedCtrls.position === 1) {\r\n    linkedCtrls.ctrls[\"prev\"].elm.style.visibility = 'visible';\r\n  }\r\n\r\n}\r\n\r\nfunction nextCtrlCallb(){\r\n  linkedCtrls.ctrls[\"next\"].elm.style.visibility = 'hidden';\r\n    return restr;\r\n  \r\n}\r\n\r\nfunction restr(){\r\n  if((linkedCtrls.position + 1) !== linkedCtrls.count){\r\n  linkedCtrls.ctrls[\"next\"].elm.style.visibility = 'visible';\r\n  }\r\n}\r\n\r\nfunction removeDistantContent(){\r\n  var prevElm = currentElm.firstChild;\r\n  if(prevElm){\r\n    easeOut(prevElm,200,function(){\r\n      prevElm.remove();\r\n    });\r\n\r\n  }\r\n}\r\n\r\nfunction setFirstDistantContent(){\r\n  toggleDistantLandmark(true);\r\n  insertDiversion(currentElm, linked[0], false, true, 200, restr);\r\n}\r\n\r\nfunction setCurrentLink(){\r\n  setPrevCtrlVisb();\r\n  var restr = nextCtrlCallb();\r\n\r\n  if(linked.length){\r\n   var  nw = linked[linkedCtrls.position];\r\n\r\n  if(currentElm.firstChild){\r\n    replaceDiversion(currentElm.firstChild, nw, restr);\r\n  } else {\r\n    insertDiversion(currentElm, nw, false, true, 200, restr);\r\n  }\r\n} else {\r\n  removeDistantContent();\r\n}\r\n}\r\n\r\nfunction setDistantSlider(){\r\nslider = getElm(\"DIV\");\r\n currentElm = getElm(\"DIV\",\"nx-distant-link\");\r\n setHistoryControls(linkedCtrls, setCurrentLink);\r\n hideDistantNav();\r\n slider.append(linkedCtrls.ctrls[\"prev\"].elm, currentElm, linkedCtrls.ctrls[\"next\"].elm);\r\n\r\n}\r\nfunction linkedElm(distantState){\r\n  \r\n  var linkedAuthor = [\r\n    authorIndexLink(distantState, false),\r\n    authorUrl(distantState, false),\r\n    viewLink(distantState, false),\r\n  ];\r\n  var elm = getElm(\"DIV\");\r\n  elm.append(...linkedAuthor);\r\n  return elm;\r\n}\r\n\r\nfunction toggleDistantLandmark(hasLinks){\r\n\r\n  var hidden = distantLandmark.style.display == \"none\";\r\n  if(hasLinks && hidden){\r\n    fadeIn(distantLandmark);\r\n  }else if(!hasLinks && !hidden){\r\n    fadeOut(distantLandmark);\r\n  }\r\n}\r\nfunction setLinkedItems(threadData) {\r\n\r\n\r\n  if (threadData != null && threadData.linked.length) {\r\n    var indexes = [];\r\n    var done = [];\r\n    var promises = [];\r\n    threadData.linked.forEach((url) => {\r\n      if(url){\r\n        var extract = splitUrlAndId(url);\r\n         var prc = resolveState(extract.url, extract.id).then((distantState) => {\r\n            var key = distantState.dataUrl+\"#\"+distantState.threadId;\r\n    \r\n            if(!done.includes(key)){\r\n              done.push(key);\r\n              var elm = linkedElm(distantState);\r\n            if (distantState.threadId == \"/\") {                 \r\n              indexes.push(elm);\r\n            } else {\r\n              elm.append(threadContent(resolveThreadData(distantState)));\r\n              linked.push(elm);\r\n\r\n\r\n              if(linkedCtrls.count === 0){\r\n            setFirstDistantContent();\r\n              }\r\n              linkedCtrls.count++;\r\n              toggleNavEnd(linkedCtrls); \r\n            }\r\n          }\r\n          }).catch(err => {\r\n            logErr(err.message);\r\n          });\r\n          promises.push(prc);\r\n    }\r\n    });\r\n   Promise.all(promises).then(()=>{\r\n     \r\n      if(indexes.length){\r\n        linked = linked.concat(indexes);\r\n        if(linkedCtrls.count === 0){\r\n          setFirstDistantContent();\r\n        }\r\n        linkedCtrls.count = linked.length;\r\n        toggleNavEnd(linkedCtrls); \r\n      } \r\n     \r\n    });\r\n  \r\n  }\r\n}\r\n\r\n\r\nfunction threadContent(threadData) {\r\n  var dv = getElm(\"DIV\", \"nx-content\");\r\n  dv.append(dateElm(threadData), contentBody(threadData), mediaElm(threadData));\r\n  return dv;\r\n}\r\n\r\nfunction contentBody(threadData) {\r\n  var bodydiv = getElm(\"DIV\", \"nx-content-body\");\r\n  bodydiv.append(\r\n    threadTextElm(threadData, [\"content\", \"main\"]),\r\n    threadTextElm(threadData, [\"content\", \"aside\"])\r\n  );\r\n  return bodydiv;\r\n}\r\n\r\nfunction dateElm(threadData) {\r\n  var datediv = getElm(\"DIV\", \"nx-content-meta\");\r\n  var rdate = threadTextElm(threadData, [\"content\", \"timestamp\"]);\r\n  datediv.append(rdate);\r\n  return datediv;\r\n}\r\n\r\nfunction threadFieldText(threadData, ref = []) {\r\n  if (threadData) {\r\n    var data = Object.assign({}, threadData);\r\n    for (var r = 0; r < ref.length; r++) {\r\n      data = data[ref[r]];\r\n    }\r\n    if (isNonEmptyStr(data)) {\r\n     \r\n      if(ref.includes(\"timestamp\") && data.includes('T')){\r\ndata = data.replace('T',\" \");\r\n      }else if([\"description\", \"main\", \"aside\", \"caption\"].includes(ref[ref.length-1])){\r\n        data = convertLineBreaks(data);\r\n      }\r\n      return data;\r\n    }\r\n  }\r\n  return \"\";\r\n}\r\n\r\nexport function threadTextElm(threadData, ref) {\r\n  var p = getElm(\"P\", \"nx-\" + ref.join(\"-\"));\r\n  p.textContent = threadFieldText(threadData, ref);\r\n  return p;\r\n}\r\n\r\nexport function threadBlocks(state) {\r\n  var threadData = resolveThreadData(state);\r\n  var blocks = [\r\n    localThreadBlock(state, threadData),\r\n    distantThreadBlock(threadData),\r\n  ];\r\n\r\nregisterUpdateEvt(function (newState) {\r\n    updateThreadBlocks(newState);\r\n  });\r\n\r\n  return blocks;\r\n}\r\n","/*! Nexus | (c) 2021 I-is-as-I-does | AGPLv3 license */\r\n\r\nimport { historyBlock } from \"./NxHistory.js\";\r\nimport { indexBlock } from \"./NxIndex.js\";\r\nimport { getElm, serviceWrap\r\n } from \"./NxCommons.js\";\r\nimport { sourceBlock } from \"./NxSource.js\";\r\nimport { threadBlocks } from \"./NxThread.js\";\r\n\r\n\r\nexport function viewerElms(state){\r\n\r\n    var indexPart = getElm(\"DIV\");\r\n    indexPart.append(indexBlock(state));\r\n    var threadPart = getElm(\"DIV\");\r\n    threadPart.append(...threadBlocks(state));\r\n    \r\n    return [serviceWrap\r\n([historyBlock(state)], [\r\n     indexPart,\r\n     threadPart\r\n     ], [sourceBlock(state)])];\r\n}"],"names":[],"sourceRoot":""}