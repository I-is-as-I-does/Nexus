/*! For license information please see 672.NexusIO.js.LICENSE.txt */
"use strict";(self.webpackChunknexus=self.webpackChunknexus||[]).push([[672],{672:(e,t,n)=>{function r(e){return("string"==typeof e||e instanceof String)&&e.length}function a(e){let t;try{t=new URL(e)}catch(e){return!1}return"http:"===t.protocol||"https:"===t.protocol}function i(e){return e.split(/[\\/]/).pop()}n.r(t),n.d(t,{build:()=>B,registerTranslElm:()=>F,registerUpdateEvt:()=>J,triggerTranslate:()=>Q,triggerUpdate:()=>M});const s={data:"Object",nexus:"String",author:"Object",handle:"String",about:"String",url:"String",threads:"Array","threads.item":"Object",id:"String",name:"String",description:"String",record:"Object",timestamp:"String",main:"String",aside:"String",media:"Object",type:"String",caption:"String",linked:"Array","linked.item":"Object"};var o=[];function l(e,t=null){var n={msg:e};r(t)&&(n.detail=t),o.push(n)}var c,u={src:null,id:"/",style:"./assets/css/NexusI.css",lang:"en",embed:!0,history:!1,log:!1},d=null;function f(){if(g("localStorage"))return localStorage}function h(e,t=!0){var n,r=(n=JSON.stringify(e),(new TextEncoder).encode(n).length);return t&&(r/=1e3),r}function g(e){var t;try{t=window[e];var n="__storage_test__";return t.setItem(n,n),t.removeItem(n),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}(d=document.querySelector("#Nexus"))?(a(d.dataset.src)&&(u.src=d.dataset.src,(!(!function(e,t,n=!0){if(s.hasOwnProperty(t)){var r=s[t];if(null!=e&&e.constructor.name==r){if(!n||(a=e)&&("object"!=typeof a||Object.keys(a).length)&&a.length)return!0;l("Field is empty",t)}else l("Invalid field type",t)}else l("Unknown field",t);var a;return!1}(c=d.dataset.id,"id",!0)||!c.match("[a-zA-Z0-9-]{3,36}"))||(l("Invalid thread id",c),!1))&&(u.id=d.dataset.id)),a(d.dataset.style)&&(u.style=d.dataset.style),r(d.dataset.lang)&&(u.lang=d.dataset.lang),"false"==d.dataset.embed&&(u.embed=!1),"true"==d.dataset.history&&(u.history=!0),"true"==d.dataset.log&&(u.log=!0)):(d=document.createElement("DIV"),document.body.append(d)),u.embed?(d.classList.add("nexus"),d=d.attachShadow({mode:"open"})):document.querySelector("html").classList.add("nexus");var m={},p=f(),v=function(){if(g("sessionStorage"))return sessionStorage}();function y(e){e&&!e.getItem("available")&&e.setItem("available",5e3)}function S(e){var t,n=e.dataSrc+"#"+e.threadId;if(!m.hasOwnProperty(n)){var r=(t=b(e.dataSrc,e.threadId))?new Date(t.record.timestamp):null;r&&(m[n]=r,function(e,t,n){if(e){var r=jsonSize(n,!0);if(r>2e3)return;var a=e.getItem("available");a<100&&function(e,t=null,n=2e3){null==t&&(t=h(e,!0));for(var r=0;r<e.length;r++){var a=e.key(r),i=h(e.getItem(a),!0);if(e.removeItem(a),(t+=i)>n)break}}(e,a,2e3),a-=r,e.setItem(t,JSON.stringify(n)),e.setItem("available",a)}}(p,n,r))}}function b(e,t){var n=x(e,t);return-1!=n?e.threads[n]:null}function x(e,t){return e&&t&&"/"!=t&&e.map.hasOwnProperty(t)?e.map[t]:-1}y(p),y(v);const O=f();var I={},w=["en"],j=null,k=null;function E(e){return r(e)&&w.includes(e)}function N(e){return!(!E(e)||e==k||(k=e,function(e){O&&j!=e&&(O.setItem("nx-lang",e),j=e)}(e),0))}function C(e){var t;return"en"!=k&&(t=I[k][e]),t||(t=e),t}!function(e){if(null!==(t=e)&&"Object"==t.constructor.name&&Object.keys(t).length)return Object.assign(I,e),w.push(...Object.keys(I).filter((e=>w.indexOf(e)<0))),!0;var t}({fr:{distant:"distant",local:"local",threads:"fils",thread:"fil",linked:"liés",record:"entrée",history:"historique",copied:"copié",embed:"intégré",source:"source","Nexus not found":"Nexus inconnu","Nexus theme not found":"Thème du Nexus inconnu","Invalid Nexus data":"Données Nexus invalides"}}),O&&(E(j=O.getItem("nx-lang"))||(j=null,O.removeItem("nx-lang"))),function(){if(j)k=j;else{var e=document.querySelector("html").lang;E(e)||(e="en"),k=e}}();var _=null;function D(){return(u.style,e=null,u.embed&&(e=d),function(e,t,n=null){return n||!function(e,t){if(document.styleSheets.length)for(var n=i(t),r=0;r<document.styleSheets.length;r++){var a=document.styleSheets[r].href;if(a){if(a==t||i(a)==n)return!0;if(a.startsWith(window.location.origin)){var s=document.styleSheets[r].cssRules;for(let t=0;t<s.length;t++)if(s[t].selectorText==e)return!0}}}return!1}(e,t)?new Promise(((e,r)=>{var a=document.createElement("link");a.rel="stylesheet",a.type="text/css",a.onload=e,a.onerror=r,a.href=t,n?n.append(a):document.head.append(a)})):Promise.resolve(!0)}(".nexus",u.style,e).catch((e=>{R(e),_="theme not found"}))).then((()=>resolveData(u.src))).then((e=>(-1==x(e,u.id)&&(u.id="/"),e)));var e}function R(e){u.log&&console.log(e)}function T(){var e;return u.lang&&(e=u.lang,j||N(e)),(u.src?D():Promise.reject(422)).catch((e=>{!function(e){_||(400===e?(R(o),_="invalid data"):_=404===e?"no response":"init failed"),d.append("Nexus | "+C(_))}(e)}))}var P={src:null,id:null},A={all:null,thread:null},U={},q={onChange:[],onSrcChange:[]},L=!1;function z(e,t){splitFlap(e,C(t),50)}function F(e,t){U[t]||(U[t]=[]),U[t].push(e)}function J(e,t=!1){var n="onChange";t&&(n="onSrcChange"),q[n].push(e)}function M(e,t,n=!1){if(!L){var r=e!=P.src;(r||t!=P.id)&&(L=!0,n||(S(P),u.history&&(history.replaceState(P,""),history.pushState(P,""))),function(e,t,n){n&&(P.src=e,A.all=getData(e)),P.id=t,A.thread=b(A.all,t)}(e,t,r),function(e){var t=["onChange"];e&&t.push("onSrcChange"),t.forEach((e=>{q[e].length&&q[e].forEach((e=>{e(current)}))}))}(r),function(){setTimeout(function(){L=!1}.bind(this),800)}())}}function Q(e){if(N(e))for(let[e,t]of Object.entries(U))t.forEach((t=>{z(t,e)}))}function B(){T().then((e=>{P.src=u.src,P.id=u.id,A.all=e,A.thread=b(e,u.id),defaultReaderBlocks(P.src,P.id),u.history&&(window.onpopstate=e=>{e.state&&e.state.src&&e.state.id&&M(e.state.src,e.state.id,!1)})}))}}}]);