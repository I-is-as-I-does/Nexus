/*! For license information please see 119.NexusIO.js.LICENSE.txt */
"use strict";(self.webpackChunknexus=self.webpackChunknexus||[]).push([[119],{119:(t,e,n)=>{function r(){if(i("localStorage"))return localStorage}function a(t,e=!0){var n,r=(n=JSON.stringify(t),(new TextEncoder).encode(n).length);return e&&(r/=1e3),r}function i(t){var e;try{e=window[t];var n="__storage_test__";return e.setItem(n,n),e.removeItem(n),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&e&&0!==e.length}}function s(t){return t instanceof Object&&null!==t}function o(t){return("string"==typeof t||t instanceof String)&&t.length}n.r(e),n.d(e,{default:()=>bt});const l={fr:{distant:"distant",local:"local",threads:"fils",thread:"fil",linked:"liés",record:"entrée",history:"historique",copied:"copié",embed:"intégré",source:"source","Nexus not found":"Nexus inconnu","Nexus theme not found":"Thème du Nexus inconnu","Invalid Nexus data":"Données Nexus invalides"}};function d(t,e=200,n=null){y(t);let r=t.offsetHeight;t.style.overflow="hidden",t.style.height=0,t.style.paddingTop=0,t.style.paddingBottom=0,t.style.marginTop=0,t.style.marginBottom=0,t.offsetHeight,t.style.boxSizing="border-box",t.style.transitionProperty="height, margin, padding",t.style.transitionDuration=e+"ms",t.style.height=r+"px",t.style.removeProperty("padding-top"),t.style.removeProperty("padding-bottom"),t.style.removeProperty("margin-top"),t.style.removeProperty("margin-bottom"),window.setTimeout((()=>{t.style.removeProperty("height"),t.style.removeProperty("overflow"),t.style.removeProperty("transition-duration"),t.style.removeProperty("transition-property"),"function"==typeof n&&n()}),e)}function c(t,e=null){t.style.opacity=1,function n(){(t.style.opacity-=.1)<0?(t.style.display="none","function"==typeof e&&e()):requestAnimationFrame(n)}()}function u(t,e=null){t.style.opacity=0,y(t),function n(){var r=parseFloat(t.style.opacity);(r+=.1)>1?"function"==typeof e&&e():(t.style.opacity=r,requestAnimationFrame(n))}()}function h(t,e=200,n=null){c(t),function(t,e=200,n=null){t.style.transitionProperty="height, margin, padding",t.style.transitionDuration=e+"ms",t.style.boxSizing="border-box",t.style.height=t.offsetHeight+"px",t.offsetHeight,t.style.overflow="hidden",t.style.height=0,t.style.paddingTop=0,t.style.paddingBottom=0,t.style.marginTop=0,t.style.marginBottom=0,window.setTimeout((()=>{t.style.display="none",t.style.removeProperty("height"),t.style.removeProperty("padding-top"),t.style.removeProperty("padding-bottom"),t.style.removeProperty("margin-top"),t.style.removeProperty("margin-bottom"),t.style.removeProperty("overflow"),t.style.removeProperty("transition-duration"),t.style.removeProperty("transition-property"),"function"==typeof n&&n()}),e)}(t,e,n)}function m(t,e=200,n=null){t.style.opacity=0;var r=e-200;r<200&&(r=200),setTimeout((function(){u(t,n)}),r),d(t,e,n)}function p(t,e,n=20){var r,a,i,s=t.textContent.split(""),o=e.split(""),l=s.length,d=o.length;l>d?(r=l,a=0,i=function(){r>d?s.pop():s[r-1]=o[r-1],r--}):(r=0,a=d,i=function(){r<l?s[r]=o[r]:s.push(o[r]),r++});var c=setInterval((function(){i(),t.textContent=s.join(""),r==a&&clearInterval(c)}),n)}function f(t,e,n=!1,r=!0,a=200,i=null){var s,o;return e.style.display="none",r?(e.style.opacity=0,s=m):s=d,o=n?function(){t.prepend(e)}:function(){t.append(e)},g(t,e,o,(function(){s(e,a,i)}))}function v(t,e,n=null){e.style.opacity=0;var r=t.parentNode,a=t.offsetHeight,i=function(){t.replaceWith(e)},s=function(){e.offsetHeight===a?u(e,n):m(e,200,n)};c(t,(function(){g(r,e,i,s)}))}function g(t,e,n,r=null){t instanceof Element||(t=document.body);var a="m"+Math.random().toString(20).substr(2);return e.classList.add(a),new Promise((i=>{var s=new MutationObserver((()=>{t.querySelector("."+a)&&(e.classList.remove(a),s.disconnect(),"function"==typeof r&&r(),i(!0))}));s.observe(t,{childList:!0}),n()}))}function y(t){t.style.removeProperty("display");let e=window.getComputedStyle(t).display;"none"===e&&(e="block"),t.style.display=e}const x=new class{constructor(){this.txts=l,this.availableLangs=Object.keys(this.txts),this.availableLangs.unshift("en"),this.store=r(),this.storeLang=null,this.lang=null,this.setStoreLang(),this.setDefaultLang(),this.textElms={}}setAdtTransl(t){s(t)&&Object.assign(this.txts,t)}setUserSelectedLang(t){this.langAvailable(t)&&(this.lang=t,this.storeLang=t,this.store&&this.store.setItem("nx-lang",t),this.updateAllTextElms())}updateAllTextElms(){for(let[t,e]of Object.entries(this.textElms))e.forEach((e=>{this.updateTextElm(e,t)}))}updateTextElm(t,e){p(t,this.get(e),50)}registerTextElm(t,e){this.textElms[e]||(this.textElms[e]=[]),this.textElms[e].push(t)}langAvailable(t){return o(t)&&this.availableLangs.includes(t)}setStoreLang(){this.store&&(this.storeLang=this.store.getItem("nx-lang"),this.langAvailable(this.storeLang)||(this.storeLang=null,this.store.removeItem("nx-lang")))}setDefaultLang(t=null){this.storeLang?this.lang=this.storeLang:(this.langAvailable(t)||(t=document.querySelector("html").lang,this.langAvailable(t)||(t="en")),this.lang=t,this.store&&this.store.setItem("nx-lang",t))}get(t){return"en"!=this.lang&&this.txts[this.lang][t]?this.txts[this.lang][t]:t}};function E(t,e=!1){var n=document.createElement("SPAN");return n.classList.add("nx-handle"),n.textContent=bt.srcData(t).author.handle,e&&bt.registerUpdateEvt((function(t){p(n,bt.srcData(t.dataSrc).author.handle,20)}),!0),n}function S(t,e=!1){var n=bt.srcData(t).author,r=document.createElement("A");r.classList.add("nx-author-url","nx-external-link"),r.target="_blank",r.href=n.url;var a=[];["[","]"].forEach((t=>{var e=document.createElement("SPAN");e.classList.add("nx-author-url-brackets"),e.textContent=t,a.push(e)}));var i=document.createElement("SPAN");return i.textContent=n.miniUrl,r.append(a[0],i,a[1]),e&&bt.registerUpdateEvt((function(t){var e=bt.srcData(t.dataSrc).author;r.href=e.url,p(i,e.miniUrl,20)}),!0),r}function L(t,e,n=!1){var r=document.createElement("SPAN");r.classList.add("nx-thread-name");var a="/";return"/"!=e&&(a=bt.threadData(t,e).name),r.textContent=a,n&&bt.registerUpdateEvt((function(t){var e="/";"/"!=t.threadId&&(e=bt.threadData(t.dataSrc,t.threadId).name),p(r,e,15)})),r}function b(t,e,n){I(t,e,n),function(t,e,n){t.classList.contains("nx-on-display")?(t.classList.remove("nx-unseen"),t.lastChild.textContent=""):bt.isThreadRecordUnseen(e,n)&&(t.classList.add("nx-unseen"),t.lastChild.textContent="*")}(t,e,n)}function I(t,e,n){e==bt.current.dataSrc&&n==bt.current.threadId?t.classList.add("nx-on-display"):t.classList.remove("nx-on-display")}function D(t,e,n){var r=document.createElement("A");return r.classList.add("nx-view-link"),r.append(L(t,e,n)),r}function C(t,e,n=!1){var r,a=D(t,e,n);return"/"!=e&&(a.append(((r=document.createElement("SPAN")).classList.add("nx-new-tag"),r)),b(a,t,e),bt.registerUpdateEvt((function(){b(a,t,e)}))),a.addEventListener("click",(()=>{bt.triggerUpdate(t,e)})),a}function w(t,e=!1){var n=document.createElement("A");return n.classList.add("nx-author-link"),n.append(E(t,e)),n.addEventListener("click",(function(){bt.triggerUpdate(t,"/")})),n}var P=null,k=1,A=1,N={"<":null,">":null};function T(t,e){var n=function(t,e){(P=document.createElement("UL")).classList.add("nx-history-list");var n=document.createElement("LI");n.textContent="...",P.append(n),P.append(j(t,e));var r=document.createElement("DIV");return r.classList.add("nx-history-drawer"),r.append(P),r.style.display="none",bt.registerUpdateEvt((function(t){!function(t){if(!bt.isHistoryEvent){k>10&&(P.children[1].remove(),k--),A=k;var e=j(t.dataSrc,t.threadId);f(P,e,!1,!0,200,(function(){O()})),V()}}(t)})),r}(t,e);return mt("history",null,[U(n),n],!1)}function U(t){var e=document.createElement("DIV");return e.classList.add("nx-history-nav"),Object.keys(N).forEach((t=>{N[t]=document.createElement("A"),N[t].classList.add("nx-nav-end"),N[t].textContent=t,N[t].addEventListener("click",(function(){N[t].classList.contains("nx-nav-end")||("<"==t?A--:A++,V(),P.children[A].querySelector(".nx-thread-name").click())}))})),e.append(N["<"],function(t){var e=document.createElement("A");return e.classList.add("nx-history-toggle"),e.textContent="≚",e.addEventListener("click",(()=>{"≙"==e.textContent?(e.textContent="≚",e.classList.remove("nx-active"),h(t,200)):(e.textContent="≙",e.classList.add("nx-active"),m(t,200),O())})),e}(t),N[">"]),e}function O(){P.scrollIntoView({block:"end",behavior:"smooth"})}function V(){A>1?N["<"].classList.remove("nx-nav-end"):N["<"].classList.add("nx-nav-end"),A<k-1?N[">"].classList.remove("nx-nav-end"):N[">"].classList.add("nx-nav-end")}function j(t,e){k++;var n=document.createElement("LI");return n.append(w(t,!1),S(t,!1),function(t,e){var n=D(t,e,!1);return I(n,t,e),bt.registerUpdateEvt((function(){I(n,t,e)})),n.addEventListener("click",(()=>{bt.triggerUpdate(t,e,!0)})),n}(t,e)),n}function R(t,e){return mt("source",null,function(t,e){var n=document.createElement("DIV");n.classList.add("nx-source-drawer"),n.append(function(t,e){return W("json",[q(t,e)])}(t,e),function(t,e){return W("embed",[B(t,e)])}(t,e)),n.style.display="none";var r=document.createElement("DIV");r.classList.add("nx-source-toggle");var a,i,s,o=(a=n,"</>",i="< />",(s=H("snippets","</>")).addEventListener("click",(()=>{s.textContent==i?(s.textContent="</>",s.classList.remove("nx-active"),h(a,100)):(s.textContent=i,s.classList.add("nx-active"),m(a,100,(function(){a.scrollIntoView({block:"end",behavior:"smooth",inline:"nearest"})})))})),s);return r.append(o),[r,n]}(t,e),!1)}function H(t,e){var n=document.createElement("A");return n.classList.add("nx-source-"+t),n.textContent=e,n}function M(t,e){return'{"url": "'+t+'", "threadId": "'+e+'"}'}function _(t,e){var n=document.createElement("TEXTAREA");return n.spellcheck=!1,n.textContent=t,bt.registerUpdateEvt((function(t){var r=e(t);n.textContent=r})),n}function q(t,e){return _(M(t,e),(function(t){return M(t.dataSrc,t.threadId)}))}function B(t,e){var n=_(z(t,e),(function(t){return z(t.dataSrc,t.threadId,n.dataset.embed)}));return n.dataset.embed=!0,n}function F(t){var e,n,r=H("copy","⧉"),a=("nx-source-copy-tooltip",e="copied",(n=document.createElement("SPAN")).classList.add("nx-source-copy-tooltip"),n.textContent=e,n.style.opacity=0,n.hidden=!0,x.registerTextElm(n,e),n);return r.append(a),r.addEventListener("click",(()=>{return e=t.textContent,n=()=>{!function(t,e=200,n=null){var r=[c,u];(function(t){if(!t)return!1;do{if(t instanceof Element){if(t.hidden||!t.offsetHeight)return!0;var e=window.getComputedStyle(t);if("0"==e.width||"0"==e.height||"0"==e.opacity||"none"==e.display||"hidden"==e.visibility)return!0}}while(t=t.parentNode);return!1})(t)&&r.reverse(),r[0](t,(function(){"function"==typeof n&&n(),window.setTimeout((()=>{r[1](t)}),e)}))}(a,1e3)},void navigator.clipboard.writeText(e).then((()=>n()));var e,n})),r}function W(t,e){var n=document.createElement("DIV");return n.classList.add("nx-"+t+"-snippet"),e.push(F(e[0])),n.append(...e),n}function z(t,e){return'<div id="Nexus" data-src="'+t+'" data-id="'+e+'" data-style="'+bt.themeCssUrl+'" data-lang="'+x.lang+'" data-embed="true" data-history="false"></div>\r\n<script src="./assets/js/io/NxReaderIO.js"><\/script>'}function J(){var t="nx-selected-lang",e=document.createElement("SPAN");e.classList.add("nx-lang-list-toggle"),e.textContent=x.lang;var n=document.createElement("UL");n.classList.add("nx-lang-list"),x.availableLangs.forEach((r=>{var a=document.createElement("LI");a.textContent=r,r==x.lang&&a.classList.add(t),a.addEventListener("click",(()=>{var r=a.textContent;r!=x.lang&&(n.querySelector("."+t).classList.remove(t),a.classList.add(t),p(e,r,50),x.setUserSelectedLang(r)),n.style.display="none"})),n.append(a)})),n.style.display="none";var r=document.createElement("DIV");return r.classList.add("nx-lang-switch"),r.append(e,n),e.addEventListener("click",(()=>{var t="none";n.style.display==t&&(t="block"),n.style.display=t})),r}function Q(t){let e;try{e=new URL(t)}catch(t){return!1}return"http:"===e.protocol||"https:"===e.protocol}function G(t){return fetch(t).then((t=>t.json()))}function X(t){return t.split(/[\\/]/).pop()}function Z(t,e=!0){var n=t.replace(/^(https?:\/\/)?/,"").split("/");if(t=n[0],e&&n.length>1){n.length>2&&(t+="/...");var r=n.pop();r.length>18&&(r="..."+r.substr(-15)),t+="/"+r}return t}function K(t,e,n,r=null){var a,i={page:$,image:nt,video:tt,audio:et},s=function(n){t.className="nx-"+e+"-media",r?v(r,n):f(t,n,!1,!0,200)};i.hasOwnProperty(e)?s(i[e](n)):(a=function(t,e,n=null,r=null){e=e.toLowerCase();var a={youtube:"https://youtube.com/oembed?url=",vimeo:"https://vimeo.com/api/oembed.json?url=",soundcloud:"https://soundcloud.com/oembed?format=json&url="};return!!a.hasOwnProperty(e)&&(t=a[e]+encodeURIComponent(t),null!=n&&(t+="&maxwidth="+n),null!=r&&(t+="&maxheight="+r),t)}(n,e,360),G(a).then((t=>{if(t&&t.hasOwnProperty("html"))return t.html;throw"invalid oembed response"}))).then((t=>{var e=document.createElement("DIV");e.insertAdjacentHTML("afterbegin",t),s(e)})).catch((t=>{bt.logEvent(t),s(Y(n))}))}function Y(t){var e=document.createElement("DIV");return e.classList.add("nx-boken-media"),e.append(function(t){var e=document.createElement("A");return e.classList.add("nx-external-link"),e.target="_blank",e.href=t,e.textContent=Z(t,!0),e}(t)),e}function $(t){var e=document.createElement("A");return e.classList.add("nx-external-link"),e.href=t,e.target="_blank",e.textContent=Z(t,!0),e}function tt(t){var e=document.createElement("VIDEO");e.setAttribute("controls",!0);var n=document.createElement("SOURCE");return n.src=t,e.append(n),n.onerror=()=>{v(e,Y(t))},e}function et(t){var e=document.createElement("AUDIO");return e.setAttribute("controls",!0),e.src=t,e.onerror=()=>{v(e,Y(t))},e}function nt(t){var e=document.createElement("IMG");return e.src=t,e.onerror=()=>{v(e,Y(t))},e}function rt(t,e){var n=null;"/"!=e&&(n=bt.threadData(t,e));var r=[L(t,e,!0)],a=function(t){var e=document.createElement("DIV");e.classList.add("nx-thread-description");var n=ot(t,["description"]);return e.append(n),e}(n),i=st(n);return bt.registerUpdateEvt((function(t){var e=bt.threadData(t.dataSrc,t.threadId),n=st(e),r=ot(e,["description"]);v(a.firstChild,r),v(a.nextElementSibling,n)})),mt("local",r,[a,i],!0)}function at(t,e){var n=document.createElement("DIV");return n.append(...it(t,e)),bt.registerUpdateEvt((function(t){var e=it(t.dataSrc,t.threadId);Array.from(n.children).forEach(((t,n)=>{v(t,e[n])}))})),mt("distant",null,[n],!0)}function it(t,e){var n=[];"/"!=e&&(n=bt.threadData(t,e).linked);var r=document.createElement("UL");r.classList.add("nx-distant-records");var a=document.createElement("UL");if(a.classList.add("nx-distant-indexes"),n.length){var i=[];n.forEach((t=>{bt.loadData(t.url).then((()=>{"/"!=t.id&&(t.id=bt.resolveThreadId(t.url,t.id));var e,n=[w(t.url,!1),S(t.url,!1),C(t.url,t.id,!1)];"/"==t.id?i.includes(t.id)||(i.push(t.id),(e=document.createElement("LI")).append(...n),f(a,e,!1,!1,200)):((e=document.createElement("LI")).append(...n),e.append(st(bt.threadData(t.url,t.id))),f(r,e,!1,!1,200))}))}))}else{var s=document.createElement("LI");s.textContent="...",r.append(s)}return[r,a]}function st(t){var e=document.createElement("DIV");return e.classList.add("nx-record"),e.append(function(t){var e=document.createElement("DIV");return e.classList.add("nx-record-meta"),e.append(ot(t,["record","timestamp"])),e}(t),function(t){var e=document.createElement("DIV");return e.classList.add("nx-record-body"),e.append(ot(t,["record","main"]),ot(t,["record","aside"])),e}(t),function(t){var e=document.createElement("DIV");return e.classList.add("nx-record-media"),e.append(function(t){var e=document.createElement("DIV");return t&&t.record.media.type&&K(e,t.record.media.type,t.record.media.url),bt.registerUpdateEvt((function(t){!function(t,e,n){var r=t.firstChild;if("/"==n)r&&(t.className="",h(r,(function(){t.removeChild(r)}),200));else{var a=bt.threadData(e,n).record.media;a.type&&K(t,a.type,a.url,r)}}(e,t.dataSrc,t.threadId)})),e}(t),function(t){return ot(t,["record","media","caption"])}(t)),e}(t)),e}function ot(t,e){var n=document.createElement("P");return n.classList.add("nx-"+e.join("-")),n.textContent=function(t,e=[]){if(t){for(var n=t,r=0;r<e.length;r++)n=n[e[r]];if(o(n))return n}return""}(t,e),n}function lt(t){return mt("index",[E(t,!0),S(t,!0)],[dt(t),ut(t)],!0)}function dt(t){var e=document.createElement("DIV");return e.classList.add("nx-about-author"),e.append(ct(t)),bt.registerUpdateEvt((function(t){v(e.firstChild,ct(t.dataSrc))}),!0),e}function ct(t){var e=document.createElement("P");return e.textContent=bt.srcData(t).author.about,e}function ut(t){var e=document.createElement("UL"),n=Object.keys(bt.srcData(t).map);if(n.length)for(var r=0;r<n.length;r++)e.append(ht(t,n[r]));return bt.registerUpdateEvt((function(t){!function(t,e){var n=t.childNodes,r=Object.keys(bt.srcData(e.dataSrc).map),a=r.length,i=n.length,s=0;if(i)for(var o=function(t){h(t,200,(function(){t.remove()}))},l=0;l<i;l++)if(a>l){var d=ht(e.dataSrc,r[l]);v(n[l],d),s++}else o(n[l]);if(s<a)for(var c=s;c<a;c++)f(t,ht(e.dataSrc,r[c]),!1,!0,200)}(e,t)}),!0),e}function ht(t,e){var n=document.createElement("LI");return n.append(C(t,e,!1)),n}function mt(t,e=null,n=null,r=!1){var a,i,s=document.createElement("SECTION");if(s.classList.add("nx-"+t,"nx-block"),r&&s.append((a=t,(i=document.createElement("SPAN")).classList.add("nx-landmark","nx-landmark-"+a),i.textContent=x.get(a),x.registerTextElm(i,a),i)),e){var o=document.createElement("HEADER");o.append(...e),s.append(o)}return n&&s.append(...n),s}function pt(t){var e=document.createElement("MAIN");return e.append(...t),e}function ft(t){var e=document.createElement("DIV");return e.append(...t),e}function vt(t){var e=document.createElement("FOOTER");return e.append(...t),e}function gt(t){var e={handle:[3,30],about:[0,400],id:[3,36],name:[3,30],description:[0,400],main:[1,1e3],aside:[0,400],caption:[0,200]};return!!e.hasOwnProperty(t)&&e[t]}function yt(t){var e={threads:100,linked:100};return!!e.hasOwnProperty(t)&&e[t]}function xt(t,e){if(o(t)&&function(t,e){var n=gt(e);return!n||t.length>=n[0]}(t,e))return function(t,e){var n=gt(e);return!1===n||t.length<=n[1]}(t,e)||(t=function(t,e){var n,r,a=gt(e);return a?(n=t,r=a[1],n.length>r&&(n=n.substr(0,r-5)+"(...)"),n):t}(t,e)),t;var n=gt(e);return 0===n?"":"-".repeat(n)}function Et(t){return s(t)&&o(r=t.timestamp)&&!isNaN(new Date(r))&&o(t.main)&&(t.main=xt(t.main,"main"),t.main)?(t.aside=xt(t.aside,"aside"),t.media=s(e=t.media)&&Q(e.url)&&o(n=e.type)&&["page","video","image","audio","youtube","vimeo","soundcloud"].includes(n)?(e.caption=xt(e.caption,"caption"),e):{url:"",type:"",caption:""},t):null;var e,n,r}function St(t){return o(t)&&(e=t,!(n=gt("id"))||e.length>=n[0]&&e.length<=n[1])&&t.replace(/[^a-zA-Z0-9-]/,"")===t;var e,n}function Lt(t){return s(t)&&Q(t.nexus)&&(t.author=s(e=t.author)&&Q(e.url)&&(e.handle=xt(e.handle,"handle"),e.handle)?(e.about=xt(e.about,"about"),e):null,t.author&&(t.threads=function(t){if((r=t)instanceof Array&&r.length){t=t.slice(0,yt("threads"));for(var e=0;e<t.length;e++)t[e]=s(n=t[e])&&St(n.id)&&(n.record=Et(n.record),n.record)?(n.name=xt(n.name,"name"),n.description=xt(n.description,"description"),n.linked=function(t){for(var e,n=t.slice(0,yt("linked")),r=[],a=0;a<n.length;a++){if(s(e=n[a])&&Q(e.url)&&St(e.id)){var i=n[a].id+n[a].url;if(!r.includes(i)){r.push(i);continue}}n.splice(a,1)}return n.length&&n.sort(((t,e)=>t.url<e.url?1:-1)),n}(n.linked),n):null,t[e]||t.splice(e,1);return t}var n,r;return[]}(t.threads),t.threads.length))?t:null;var e}const bt=new class{constructor(){this.container=null,this.themeCssUrl="./assets/css/NexusI.css",this.embedMode=!1,this.logMode=!1,this.shadow=!1,this.metaElm=null,this.browserHistory=!1,this.loadedCss={},this.current={dataSrc:null,threadId:null},this.origin={dataSrc:null,threadId:null},this.bufferTime=800,this.originLang="en",this.isHistoryEvent=!1,this.updateStore={onChange:[],onSrcChange:[]},this.updateRunning=!1,this.doneLoadingEvt=new CustomEvent("Done"),this.visitStore={},this.dataStore={},this.locStore=r(),this.sesStore=function(){if(i("sessionStorage"))return sessionStorage}(),this.#t(this.locStore),this.#t(this.sesStore),window.onpopstate=function(t){t.state&&t.state.dataSrc&&t.state.threadId&&this.triggerUpdate(t.state.dataSrc,t.state.threadId)}.bind(this)}#t(t){t&&!t.getItem("available")&&t.setItem("available",5e3)}#e(t,e){this.dataStore[t]=e,this.#n(this.sesStore,t,e)}threadDate(t,e){var n=this.threadData(t,e);return n?new Date(n.record.timestamp):null}threadLastSeenDate(t,e){var n,r=t+"#"+e;return this.visitStore.hasOwnProperty(r)?n=this.visitStore[r]:this.locStore&&(n=this.locStore.getItem(r)),n?new Date(n):null}isThreadRecordUnseen(t,e){var n=this.threadLastSeenDate(t,e);if(!n)return!0;var r=this.threadDate(t,e);return!r||n==r}#r(t){return this.container?(this.logEvent("NxThalamus: container already set"),!1):t&&t instanceof Element||(t=document.querySelector("#Nexus"))?(this.container=t,this.#a(),this.#i(),!0):(console.log("NxThalamus: Nexus element not found"),!1)}#a(){Q(this.container.dataset.src)&&(this.origin.dataSrc=this.container.dataset.src,St(this.container.dataset.id)&&(this.origin.threadId=this.container.dataset.id)),Q(this.container.dataset.style)&&(this.themeCssUrl=this.container.dataset.style),o(this.container.dataset.lang)&&(this.originLang=this.container.dataset.lang),"true"==this.container.dataset.embed&&(this.embedMode=!0),"true"==this.container.dataset.history&&(this.browserHistory=!0),"true"==this.container.dataset.log&&(this.logMode=!0)}#i(){this.embedMode?(this.shadow=!0,this.metaElm=this.container.attachShadow({mode:"open"}),this.container.classList.add("nexus")):(this.metaElm=this.container,document.querySelector("html").classList.add("nexus"))}setDebugMode(){this.logMode=!0}loadStyle(t){if(this.loadedCss[t])return 200===this.loadedCss[t]?Promise.resolve(200):Promise.reject(404);var e=null;return this.shadow&&(e=this.metaElm),function(t,e,n=null){return n||!function(t,e){if(document.styleSheets.length)for(var n=X(e),r=0;r<document.styleSheets.length;r++){var a=document.styleSheets[r].href;if(a){if(a==e||X(a)==n)return!0;if(a.startsWith(window.location.origin)){var i=document.styleSheets[r].cssRules;for(let e=0;e<i.length;e++)if(i[e].selectorText==t)return!0}}}return!1}(t,e)?new Promise(((t,r)=>{var a=document.createElement("link");a.rel="stylesheet",a.type="text/css",a.onload=t,a.onerror=r,a.href=e,n?n.append(a):document.head.append(a)})):Promise.resolve(!0)}(".nexus",t,e).then((()=>{this.loadedCss[t]=200})).catch((e=>{throw this.logEvent(e),this.loadedCss[t]=404,404}))}logEvent(t){this.logMode&&console.log(t)}loadData(t){var e=this.srcData(t);return e?Number.isInteger(e)?Promise.reject(e):Promise.resolve(200):G(t).then((e=>{if(e=Lt(e))return e.map={},e.threads.map(((t,n)=>{e.map[t.id]=n})),e.author.miniUrl=function(t){for(var e=t.replace(/^(https?:\/\/)?(www.)?/,"").split(":")[0].split("/")[0].split("."),n=0;n<e.length;n++)if(e[n].includes("-"))e[n]=e[n].split("-").map((t=>t[0])).join("-");else{for(var r=e[n].split(""),a=0,i=0;i<r.length;i++)["a","e","i","o","u","y"].includes(r[i])&&(0!==a&&i!==a+1?r[i]="":a=i);e[n]=r.join("")}return e.join(".")}(e.author.url),this.#e(t,e),200;throw this.logEvent("NxThalamus: invalid data"),400})).catch((e=>{throw this.logEvent(e),400!==e&&(e=404),this.#e(t,e),e}))}#s(){if(!this.current.dataSrc){if(!this.origin.dataSrc)return!1;this.current=this.origin}return!0}autoloadReader(t=null){this.initPage(function(){var t,e,n,r,a;this.metaElm.append((t=this.current.dataSrc,e=this.current.threadId,function(t){var e=document.createElement("DIV");return e.classList.add("nx-instance"),e.append(...t),e}([(r=[mt("app",null,[(n=document.createElement("A"),n.target="_blank",n.classList.add("nx-app-link","nx-external-link"),n.href="https://github.com/I-is-as-I-does/NexusApp",n.title="Nexus",n.textContent="Nexus",n),J()],!1),T(t,e)],a=document.createElement("HEADER"),a.append(...r),a),pt([ft([lt(t)]),ft([rt(t,e),at(t,e)])]),vt([R(t,e)])])))}.bind(this),null,t)}initPage(t,e=null,n=null){var r;this.#r(n)&&this.#s()?(x.setDefaultLang(this.originLang),r=this.loadStyle(this.themeCssUrl).then((()=>this.loadData(this.current.dataSrc))).then((()=>(this.current.threadId=this.resolveThreadId(this.current.dataSrc,this.current.threadId),t())))):(this.logEvent("NxThalamus: unable to init page"),r=Promise.reject(422)),r.catch((t=>{this.#o(t,e)}))}#o(t,e=null){if(this.logEvent(t),this.metaElm){var n="Invalid Nexus data";404===this.loadedCss[this.themeCssUrl]?n="Nexus theme not found":this.current.dataSrc&&404===this.srcData(this.current.dataSrc)&&(n="Nexus not found"),this.current.dataSrc=null,this.current.threadId=null,f(this.metaElm,function(t){var e=document.createElement("P");e.classList.add("nx-error");var n=document.createElement("SPAN");n.textContent="—/ — ";var r=document.createElement("SPAN");return t="Nexus not found",r.textContent=x.get(t),x.registerTextElm(r,t),e.append(n,r),e}(n),!1,!0,200)}"function"==typeof e&&e()}#l(){this.browserHistory&&(history.replaceState(this.current,""),history.pushState(this.current,""))}#d(t,e){var n=t+"#"+e;if(!this.visitStore.hasOwnProperty(n)){var r=this.threadDate(t,e);r&&(this.visitStore[n]=r,this.#n(this.locStore,n,r))}}#n(t,e,n){if(t){var r=a(n,!0);if(r>2e3)return;var i=t.getItem("available");i<100&&function(t,e=null,n=2e3){null==e&&(e=a(t,!0));for(var r=0;r<t.length;r++){var i=t.key(r),s=a(t.getItem(i),!0);if(t.removeItem(i),(e+=s)>n)break}}(t,i,2e3),i-=r,t.setItem(e,JSON.stringify(n)),t.setItem("available",i)}}triggerUpdate(t,e,n=!1){if(!this.updateRunning){var r=t!=this.current.dataSrc;if(r||e!=this.current.threadId){this.updateRunning=!0,this.isHistoryEvent=n,n||(this.#d(this.current.dataSrc,this.current.threadId),this.#l()),this.current.dataSrc=t,this.current.threadId=e;var a=["onChange"];r&&a.push("onSrcChange"),a.forEach((t=>{this.updateStore[t].length&&this.updateStore[t].forEach((t=>{t(this.current)}))})),setTimeout(function(){this.updateRunning=!1}.bind(this),this.bufferTime)}}}registerUpdateEvt(t,e=!1){var n="onChange";e&&(n="onSrcChange"),this.updateStore[n].push(t)}srcData(t){if(this.dataStore.hasOwnProperty(t))return this.dataStore[t];if(this.sesStore){var e=this.sesStore.getItem(t);if(e)return JSON.parse(e)}return!1}threadData(t,e){if(e&&"/"!=e){var n=this.srcData(t);if(n&&n.map.hasOwnProperty(e))return n.threads[n.map[e]]}return null}resolveThreadId(t,e){return this.threadData(t,e)?e:"/"}}}}]);