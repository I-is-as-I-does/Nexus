<template>
  <div id="app" v-if="nearest || nonProduct" ref="app">
    <img
      v-if="trimmedImgHash_str"
      :style="btnStyle"
      v-img="vImgParams"
      @click="goBignameShop"/>
    <div
      v-else
      :style="placeHolderStyle"
      @click="goBignameShop"/>
  </div>
</template>

<script>
import Geohash from 'geohash.js'
import utils from 'h5-utils'

export default {
  name: 'BannerPlugin',
  data() {
    return {
      nearest: null,
      devHost: ['app-builder.faas.ele.me', 'localhost:8080'],
    }
  },
  props: {
    data: {
      type: Object,
      default() {
        return {}
      },
    },
    geohash: String,
  },
  computed: {
    // 方便运营在编辑环境的时候看到banner展示
    nonProduct() {
      return this.devHost.includes(location.host)
    },

    btnStyle() {
      const { width, height } = this.data
      const ROOT = 75 // 根字体大小为75px
      return {
        width: `${width / ROOT}rem`,
        height: `${height / ROOT}rem`,
      }
    },
    trimmedImgHash_str() {
      return this.data.imgHashs.trim()
    },
    daysPassed() {
      const [ startYear, startMonth, startDay ] = this.data.startDate.match(/(\d+)\.(\d+)\.(\d+)/).slice(1)
      const millisecondsPassed = Date.now() - new Date(startYear, startMonth - 1, startDay)

      // 如果运营配置的是未来的某一天，那么假设今天是第一天
      if (millisecondsPassed < 0) return 0

      return Math.floor(millisecondsPassed / (24 * 60 * 60 * 1000))
    },
    vImgParams() {
      const {
        width,
        height,
      } = this.data
      const imgHashs_array = this.trimmedImgHash_str.split(/, */)
      const showedImgHash = imgHashs_array[this.daysPassed % imgHashs_array.length]

      return {
        width,
        height,
        hash: showedImgHash,
      }
    },

    placeHolderStyle() {
      return Object.assign(this.btnStyle, {
        background: 'rgba(0, 0, 0, 0.3)',
      })
    },

    brandIds() {
      return this.data.brandIds.split(/, */)
    },
  },
  methods: {
    goBignameShop() {
      const UA = navigator.userAgent
      const isElemeApp = /Eleme/i.test(UA) 

      location.href = isElemeApp
        ? `eleme://restaurant?restaurant_id=${this.nearest.restaurant.id}`
        : `//h5.ele.me/shop/#id=${this.nearest.restaurant.id}`
    }
  },
  mounted() {
    utils
      .getLocation()
      .then(({ latitude, longitude }) => {
        const activity_id = this.brandIds[this.daysPassed % this.brandIds.length]
        const queryString = `activity_id=${activity_id}&latitude=${latitude}&longitude=${longitude}&limit=1&offset=0`
        fetch(`//mainsite-restapi.ele.me/shopping/v1/cluster_activity/${activity_id}/restaurants?${queryString}`, {
          credentials: 'include',
          headers: {
            'x-shard': `loc=${longitude},${latitude}`,
          },
        })
          .then(response => response.json())
          .then((data) => {
            this.nearest = data.restaurants[0]

            if (!nearest) {
              this.$refs.app.parentElement.style.display = 'none'
            }
          })
          .catch(() => {})
      })
      .catch((err) => {
        console.log(err)
      })
  },
}
</script>
